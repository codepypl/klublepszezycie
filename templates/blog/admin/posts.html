{% extends "admin/base.html" %}

{% block title %}Artykuły{% endblock %}

{% block page_title %}
    <i class="fas fa-newspaper me-2"></i>Zarządzanie Artykułami
{% endblock %}

{% block page_actions %}
    <div class="d-flex justify-content-end gap-2 mb-3">
        <button class="btn admin-btn" data-bs-toggle="modal" data-bs-target="#addPostModal">
            <i class="fas fa-plus me-2"></i>
            Dodaj Artykuł
        </button>
        <button class="btn admin-btn-danger" id="bulkDeleteBtn">
            <i class="fas fa-trash me-2"></i>
            Usuń Zaznaczone
        </button>
    </div>
{% endblock %}

{% block content %}
    <!-- Posts Table -->
    <div class="admin-card">
        <div class="admin-card-body">
            {% if posts.items %}
                <div class="table-responsive">
                    <table id="postsTable" class="table admin-table bulk-delete-table" data-delete-endpoint="/api/blog/admin/posts/bulk-delete">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th>ID</th>
                                <th>Tytuł</th>
                                <th>Slug</th>
                                <th>Kategorie</th>
                                <th>Status</th>
                                <th>Data publikacji</th>
                                <th>Komentarze</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for post in posts.items %}
                            <tr data-post-id="{{ post.id }}">
                                <td>
                                    <input type="checkbox" name="itemIds" value="{{ post.id }}">
                                </td>
                                <td>
                                    <span class="badge admin-badge admin-badge-primary">{{ post.id }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if post.featured_image %}
                                            <img src="{{ post.featured_image }}" alt="{{ post.title }}" class="img-thumbnail me-2">
                                        {% endif %}
                                        <div>
                                            <strong>{{ post.title }}</strong>
                                        </div>
                                    </div>
                                </td>
                                <td><code>{{ post.slug }}</code></td>
                                <td>
                                    {% for category in post.categories %}
                                        <a href="#" onclick="editCategory({{ category.id }})" 
                                           class="badge admin-badge admin-badge-primary me-1" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="{{ category.title }}">
                                            {{ category.id }}
                                        </a>
                                    {% endfor %}
                                </td>
                                <td>
                                    {% if post.status == 'published' %}
                                        <span class="badge admin-badge admin-badge-success">Opublikowany</span>
                                    {% elif post.status == 'draft' %}
                                        <span class="badge admin-badge admin-badge-warning">Szkic</span>
                                    {% else %}
                                        <span class="badge admin-badge admin-badge-secondary">{{ post.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ post.published_at.strftime('%d.%m.%Y %H:%M') if post.published_at else 'Brak daty' }}</td>
                                <td>
                                    <span class="badge admin-badge admin-badge-info">{{ post.comments.count() }}</span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm admin-btn-outline" onclick="editPost({{ post.id if post.id else 0 }})" title="Edytuj">
                                            <i class="fas fa-pen"></i>
                                        </button>
                                        <button class="btn btn-sm admin-btn-danger-outline" onclick="deletePost({{ post.id if post.id else 0 }})" title="Usuń">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div id="pagination" class="mt-4 pagination-container" 
                     data-show-info="true" 
                     data-show-per-page="true" 
                     data-default-per-page="10" 
                     data-max-visible-pages="5"></div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Brak artykułów</h5>
                    <p class="text-muted">Dodaj pierwszy artykuł, aby rozpocząć blogowanie</p>
                    <button type="button" class="btn admin-btn" data-bs-toggle="modal" data-bs-target="#addPostModal">
                        <i class="fas fa-plus me-2"></i>
                        Dodaj Artykuł
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Add Post Modal -->
    <div class="modal fade" id="addPostModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Dodaj Nowy Artykuł
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addPostForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="postTitle" class="form-label">Tytuł artykułu *</label>
                                    <input type="text" class="form-control" id="postTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="postSlug" class="form-label">Slug *</label>
                                    <input type="text" class="form-control" id="postSlug" name="slug" required>
                                    <div class="form-text">URL-friendly wersja tytułu</div>
                                </div>
                                <div class="mb-3">
                                    <label for="postExcerpt" class="form-label">Krótki opis</label>
                                    <textarea class="form-control" id="postExcerpt" name="excerpt" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="postStatus" class="form-label">Status</label>
                                    <select class="form-select" id="postStatus" name="status">
                                        <option value="draft">Szkic</option>
                                        <option value="published">Opublikowany</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="postFeaturedImage" class="form-label">Zdjęcie główne</label>
                                    <input type="file" class="form-control" id="postFeaturedImage" name="featured_image" accept="image/*">
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>Zalecany rozmiar:</strong> 1200×675px (16:9) lub 1200×800px (3:2)<br>
                                        <strong>Format:</strong> JPG, PNG, WebP | <strong>Maksymalny rozmiar:</strong> 5MB
                                    </div>
                                    <div class="form-text">Opcjonalnie</div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="postAllowComments" name="allow_comments" checked>
                                        <label class="form-check-label" for="postAllowComments">
                                            Zezwól na komentarze
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="postContent" class="form-label">Treść artykułu *</label>
                            <textarea class="form-control" id="postContent" name="content" rows="10" data-quill></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Kategorie</label>
                            <div id="postCategories" class="form-check-container">
                                <!-- Checkboxes will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tagi</label>
                            <div id="postTagsSelector"></div>
                        </div>
                        
                        <!-- Images Section -->
                        <div class="mb-3">
                            <label class="form-label">Obrazy w artykule</label>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Galeria zdjęć będzie dostępna po utworzeniu artykułu. Możesz dodać obrazy podczas edycji.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn admin-btn-outline" data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn admin-btn">Dodaj Artykuł</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div class="modal fade" id="editPostModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-pen me-2"></i>Edytuj Artykuł
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editPostForm" enctype="multipart/form-data">
                    <input type="hidden" id="editPostId" name="id">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editPostTitle" class="form-label">Tytuł artykułu *</label>
                                    <input type="text" class="form-control" id="editPostTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editPostSlug" class="form-label">Slug *</label>
                                    <input type="text" class="form-control" id="editPostSlug" name="slug" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editPostExcerpt" class="form-label">Krótki opis</label>
                                    <textarea class="form-control" id="editPostExcerpt" name="excerpt" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editPostStatus" class="form-label">Status</label>
                                    <select class="form-select" id="editPostStatus" name="status">
                                        <option value="draft">Szkic</option>
                                        <option value="published">Opublikowany</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editPostFeaturedImage" class="form-label">Zdjęcie główne</label>
                                    <input type="file" class="form-control" id="editPostFeaturedImage" name="featured_image" accept="image/*">
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>Zalecany rozmiar:</strong> 1200×675px (16:9) lub 1200×800px (3:2)<br>
                                        <strong>Format:</strong> JPG, PNG, WebP | <strong>Maksymalny rozmiar:</strong> 5MB
                                    </div>
                                    <div class="form-text">Wybierz nowe zdjęcie (opcjonalnie)</div>
                                    <div id="currentFeaturedImage" class="mt-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <small class="text-muted">Aktualne zdjęcie:</small>
                                            <button type="button" class="btn btn-sm admin-btn-danger-outline" onclick="window.blogPostsManager.deleteFeaturedImage()" title="Usuń zdjęcie główne">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <img id="currentFeaturedImagePreview" src="" alt="Aktualne zdjęcie" class="img-thumbnail mt-1">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="editPostAllowComments" name="allow_comments">
                                        <label class="form-check-label" for="editPostAllowComments">
                                            Zezwól na komentarze
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editPostContent" class="form-label">Treść artykułu *</label>
                            <textarea class="form-control" id="editPostContent" name="content" rows="10" data-quill></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Kategorie</label>
                            <div id="editPostCategories" class="form-check-container">
                                <!-- Checkboxes will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Images Section -->
                        <div class="mb-3">
                            <label class="form-label">Obrazy w artykule</label>
                            <div id="editPostImages" class="images-container">
                                <!-- Images will be populated by JavaScript -->
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm admin-btn-outline" id="addImageBtn">
                                    <i class="fas fa-plus me-1"></i>Dodaj Obraz
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tagi</label>
                            <div id="editPostTagsSelector"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn admin-btn-outline" data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn admin-btn">Zapisz Zmiany</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Image Modal -->
<div class="modal fade admin-modal" id="imageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-image me-2"></i>
                    <span id="imageModalTitle">Dodaj Obraz</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="imageForm">
                    <input type="hidden" id="imageId" name="image_id">
                    <input type="hidden" id="postId" name="post_id">
                    
                    <div class="mb-3">
                        <label for="imageFile" class="form-label">Upload Obrazu</label>
                        <input type="file" class="form-control" id="imageFile" name="image_file" accept="image/*" onchange="validateImageFile()">
                        <div class="form-text">Lub wklej URL poniżej. Maksymalny rozmiar: 100MB</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="imageUrl" class="form-label">URL Obrazu</label>
                        <input type="url" class="form-control" id="imageUrl" name="image_url" placeholder="https://example.com/image.jpg">
                        <div class="form-text">Wklej URL obrazu (opcjonalne jeśli uploadujesz plik)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="imageAltText" class="form-label">Alt Text</label>
                        <input type="text" class="form-control" id="imageAltText" name="alt_text" placeholder="Opis obrazu dla czytników ekranu">
                    </div>
                    
                    <div class="mb-3">
                        <label for="imageCaption" class="form-label">Podpis</label>
                        <textarea class="form-control" id="imageCaption" name="caption" rows="2" placeholder="Opcjonalny podpis pod obrazem"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="imageOrder" class="form-label">Kolejność</label>
                        <input type="number" class="form-control" id="imageOrder" name="order" min="0" value="0">
                        <div class="form-text">Niższa liczba = wyższa pozycja</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn admin-btn-outline" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn admin-btn" id="saveImageBtn">Zapisz Obraz</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin/tag_selector.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin/blog_posts.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin/blog_categories.js') }}"></script>
{% endblock %}


