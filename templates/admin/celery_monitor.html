{% extends "admin/base.html" %}

{% block title %}Monitor Celery - Panel Admin{% endblock %}

{% block page_title %}
    <i class="fas fa-tasks me-2"></i>Monitor Celery
{% endblock %}

{% block extra_css %}
<style>
.celery-status-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
}

.celery-status-card.healthy {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.celery-status-card.unhealthy {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
}

.task-card {
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.task-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.task-scheduled {
    border-left: 4px solid #ffc107;
}

.task-active {
    border-left: 4px solid #28a745;
}

.task-completed {
    border-left: 4px solid #6c757d;
}

.task-failed {
    border-left: 4px solid #dc3545;
}

.task-eta {
    font-size: 0.9em;
    color: #666;
}

.task-args {
    font-family: 'Courier New', monospace;
    font-size: 0.8em;
    background: #f8f9fa;
    padding: 5px;
    border-radius: 3px;
    margin-top: 5px;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 20px;
}

.loading-spinner.show {
    display: block;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    color: #666;
    margin-top: 5px;
}
</style>
{% endblock %}

{% block content %}

            <!-- Status Celery -->
            <div class="celery-status-card" id="celeryStatus">
                <div class="row">
                    <div class="col-md-8">
                        <h3><i class="fas fa-server me-2"></i>Status Celery</h3>
                        <p class="mb-0">Sprawdzanie połączenia...</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="workersCount">-</div>
                                <div class="stat-label">Workers</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statystyki -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="scheduledCount">-</div>
                    <div class="stat-label">Zaplanowane</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeCount">-</div>
                    <div class="stat-label">Aktywne</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="reservedCount">-</div>
                    <div class="stat-label">Zarezerwowane</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">-</div>
                    <div class="stat-label">Łącznie</div>
                </div>
            </div>

            <!-- Filtry -->
            <div class="admin-card mb-4">
                <div class="admin-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filtry
                        <button class="btn btn-sm admin-btn-outline ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse">
                            <i class="fas fa-chevron-down" id="filtersIcon"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse" id="filtersCollapse">
                    <div class="admin-card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="taskTypeFilter" class="form-label">Typ zadań</label>
                                <select class="form-select" id="taskTypeFilter" onchange="applyFilters()">
                                    <option value="all">Wszystkie</option>
                                    <option value="scheduled">Zaplanowane</option>
                                    <option value="active">Aktywne</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="eventIdFilter" class="form-label">ID Wydarzenia</label>
                                <input type="number" class="form-control" id="eventIdFilter" placeholder="Wprowadź ID wydarzenia" onchange="applyFilters()">
                            </div>
                            <div class="col-md-3">
                                <label for="limitFilter" class="form-label">Limit wyników</label>
                                <select class="form-select" id="limitFilter" onchange="applyFilters()">
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-flex gap-2">
                                    <button class="btn admin-btn" onclick="applyFilters()">
                                        <i class="fas fa-search me-2"></i>Filtruj
                                    </button>
                                    <button class="btn admin-btn-outline" onclick="clearFilters()">
                                        <i class="fas fa-times me-2"></i>Wyczyść
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista zadań -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Zadania Celery</h5>
                </div>
                <div class="admin-card-body">
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Ładowanie...</span>
                        </div>
                        <p class="mt-2">Ładowanie zadań...</p>
                    </div>
                    
                    <div id="tasksList">
                        <!-- Zadania będą ładowane tutaj -->
                    </div>
                </div>
            </div>

<script>
// Function to refresh celery data (for CRUD refresh manager)
function refreshCeleryData() {
    refreshData();
}

// Ładowanie danych przy starcie
document.addEventListener('DOMContentLoaded', function() {
    // Initialize global CRUD refresh manager for this page
    window.crudRefreshManager.init(refreshCeleryData);
    
    refreshData();
});

// Odświeżanie danych z retry
function refreshData() {
    showLoading();
    
    // Pobierz status Celery z retry
    fetchWithRetry('/admin/api/celery/status')
        .then(data => {
            updateCeleryStatus(data);
        })
        .catch(error => {
            console.error('Błąd pobierania statusu Celery:', error);
            updateCeleryStatus({success: false, error: 'Błąd połączenia'});
        });
    
    // Pobierz zadania z retry
    loadTasksWithRetry();
}

// Fetch z retry
function fetchWithRetry(url, maxRetries = 3) {
    return fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .catch(error => {
            if (maxRetries > 0) {
                console.log(`Retry ${4-maxRetries} for ${url}`);
                return new Promise(resolve => 
                    setTimeout(() => resolve(fetchWithRetry(url, maxRetries - 1)), 1000)
                );
            }
            throw error;
        });
}

// Aktualizacja statusu Celery
function updateCeleryStatus(data) {
    const statusCard = document.getElementById('celeryStatus');
    const workersCount = document.getElementById('workersCount');
    const scheduledCount = document.getElementById('scheduledCount');
    const activeCount = document.getElementById('activeCount');
    const reservedCount = document.getElementById('reservedCount');
    const totalCount = document.getElementById('totalCount');
    
    if (data.success && data.is_healthy) {
        statusCard.className = 'celery-status-card healthy';
        statusCard.innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    <h3><i class="fas fa-check-circle me-2"></i>Celery działa poprawnie</h3>
                    <p class="mb-0">Ostatnie sprawdzenie: ${new Date(data.last_check).toLocaleString()}</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${data.workers_count}</div>
                            <div class="stat-label">Workers</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        workersCount.textContent = data.workers_count;
        scheduledCount.textContent = data.total_scheduled;
        activeCount.textContent = data.total_active;
        reservedCount.textContent = data.total_reserved;
        totalCount.textContent = data.total_scheduled + data.total_active + data.total_reserved;
    } else {
        statusCard.className = 'celery-status-card unhealthy';
        statusCard.innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    <h3><i class="fas fa-exclamation-triangle me-2"></i>Problem z Celery</h3>
                    <p class="mb-0">${data.error || 'Nie można połączyć się z Celery'}</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Workers</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        workersCount.textContent = '0';
        scheduledCount.textContent = '0';
        activeCount.textContent = '0';
        reservedCount.textContent = '0';
        totalCount.textContent = '0';
    }
}

// Ładowanie zadań z retry
function loadTasksWithRetry() {
    const taskType = document.getElementById('taskTypeFilter').value;
    const eventId = document.getElementById('eventIdFilter').value;
    const limit = document.getElementById('limitFilter').value;
    
    let url = `/admin/api/celery/tasks?type=${taskType}&limit=${limit}`;
    if (eventId) {
        url += `&event_id=${eventId}`;
    }
    
    fetchWithRetry(url)
        .then(data => {
            displayTasks(data);
            hideLoading();
        })
        .catch(error => {
            console.error('Błąd pobierania zadań:', error);
            displayTasks({success: false, error: 'Błąd połączenia', tasks: []});
            hideLoading();
        });
}

// Ładowanie zadań (bez retry dla kompatybilności)
function loadTasks() {
    loadTasksWithRetry();
}

// Wyświetlanie zadań
function displayTasks(data) {
    const tasksList = document.getElementById('tasksList');
    
    if (!data.success) {
        tasksList.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Błąd: ${data.error}
            </div>
        `;
        return;
    }
    
    if (data.tasks.length === 0) {
        tasksList.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Brak zadań spełniających kryteria filtrowania.
            </div>
        `;
        return;
    }
    
    let html = '';
    data.tasks.forEach(task => {
        const taskClass = `task-${task.status}`;
        const etaText = task.eta ? new Date(task.eta).toLocaleString() : 'Brak';
        const argsText = JSON.stringify(task.args);
        
        html += `
            <div class="task-card ${taskClass}">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-tasks me-2"></i>${task.name}</h6>
                        <p class="mb-1"><strong>ID:</strong> ${task.id}</p>
                        <p class="mb-1"><strong>Status:</strong> ${task.status}</p>
                        <p class="mb-1"><strong>Worker:</strong> ${task.worker}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>ETA:</strong> <span class="task-eta">${etaText}</span></p>
                        <div class="task-args"><strong>Args:</strong> ${argsText}</div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <button class="btn btn-sm btn-outline-danger" onclick="cancelTask('${task.id}')">
                            <i class="fas fa-times me-1"></i>Anuluj
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="showTaskDetails('${task.id}')">
                            <i class="fas fa-info-circle me-1"></i>Szczegóły
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    tasksList.innerHTML = html;
}

// Anulowanie zadania
function cancelTask(taskId) {
    // Use modal confirmation instead of confirm()
    document.getElementById('bulkDeleteMessage').innerHTML = 'Czy na pewno chcesz anulować to zadanie?<br><small class="text-muted">Ta operacja nie może być cofnięta.</small>';
    
    const modal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
    modal.show();
    
    // Update confirm button
    const confirmBtn = document.getElementById('confirmBulkDelete');
    confirmBtn.onclick = function() {
    
    fetch(`/admin/api/celery/tasks/${taskId}/cancel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.toastManager.success('Zadanie zostało anulowane');
            refreshData();
        } else {
            window.toastManager.error('Błąd anulowania zadania: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Błąd anulowania zadania:', error);
        window.toastManager.error('Błąd anulowania zadania');
    });
    modal.hide();
    };
}

// Wyświetlanie szczegółów zadania
function showTaskDetails(taskId) {
    // TODO: Implementować modal ze szczegółami zadania
    alert('Szczegóły zadania: ' + taskId);
}

// Stosowanie filtrów
function applyFilters() {
    loadTasks();
}

// Czyszczenie filtrów
function clearFilters() {
    document.getElementById('taskTypeFilter').value = 'all';
    document.getElementById('eventIdFilter').value = '';
    document.getElementById('limitFilter').value = '50';
    loadTasks();
}


// Pokazywanie/ukrywanie spinnera
function showLoading() {
    document.getElementById('loadingSpinner').classList.add('show');
}

function hideLoading() {
    document.getElementById('loadingSpinner').classList.remove('show');
}
</script>
{% endblock %}
