{% extends "admin/base.html" %}

{% block title %}Harmonogramy{% endblock %}

{% block extra_css %}
    <link href="{{ url_for('static', filename='css/admin.css') }}?v={{ range(1, 1000) | random }}" rel="stylesheet">
    <style>
        .bulk-actions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .table th {
            background-color: #f8f9fa;
            border-top: none;
        }
        
        .btn-group-sm > .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
{% endblock %}

{% block page_title %}
    <i class="fas fa-calendar me-2"></i>Harmonogramy
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-clock me-2"></i>Harmonogramy
                </h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                    <i class="fas fa-plus me-2"></i>Dodaj harmonogram
                </button>
            </div>

            <!-- Lista harmonogramów -->
            <div class="card">
                <div class="card-body">
                    <!-- Bulk actions -->
                    <div class="bulk-actions mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll" name="selectAll">
                                    <label class="form-check-label" for="selectAll">
                                        Zaznacz wszystkie
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="button" class="btn btn-danger" id="bulkDeleteBtn" style="display: none;">
                                    <i class="fas fa-trash me-2"></i>Usuń wybrane (0)
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover bulk-delete-table" 
                               id="schedulesTable" 
                               data-delete-endpoint="/api/bulk-delete/schedules">
                            <thead>
                                <tr>
                                    <th width="50">
                                        <input type="checkbox" id="selectAll" name="selectAll">
                                    </th>
                                    <th>Nazwa</th>
                                    <th>Opis</th>
                                    <th>Szablon</th>
                                    <th>Typ wyzwalacza</th>
                                    <th>Odbiorcy</th>
                                    <th>Status</th>
                                    <th>Ostatnie wysłanie</th>
                                    <th>Liczba wysłanych</th>
                                    <th width="150">Akcje</th>
                                </tr>
                            </thead>
                            <tbody id="schedulesTableBody">
                                <!-- Dane będą ładowane przez JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal dodawania/edycji harmonogramu -->
<div class="modal fade" id="addScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleModalTitle">Dodaj harmonogram</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <input type="hidden" id="scheduleId" name="id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleName" class="form-label">Nazwa *</label>
                                <input type="text" class="form-control" id="scheduleName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleTemplate" class="form-label">Szablon e-mail *</label>
                                <select class="form-select" id="scheduleTemplate" name="template_id" required>
                                    <option value="">Wybierz szablon</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scheduleDescription" class="form-label">Opis</label>
                        <textarea class="form-control" id="scheduleDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleTriggerType" class="form-label">Typ wyzwalacza *</label>
                                <select class="form-select" id="scheduleTriggerType" name="trigger_type" required>
                                    <option value="">Wybierz typ</option>
                                    <option value="user_activation">Aktywacja konta użytkownika</option>
                                    <option value="event_registration">Rejestracja na wydarzenie</option>
                                    <option value="event_reminder">Przypomnienie o wydarzeniu</option>
                                    <option value="manual">Ręczne</option>
                                    <option value="scheduled">Zaplanowane</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleRecipientType" class="form-label">Typ odbiorcy *</label>
                                <select class="form-select" id="scheduleRecipientType" name="recipient_type" required>
                                    <option value="">Wybierz typ</option>
                                    <option value="user">Użytkownik</option>
                                    <option value="admin">Administrator</option>
                                    <option value="group">Grupa</option>
                                    <option value="all">Wszyscy</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleSendType" class="form-label">Typ wysłania</label>
                                <select class="form-select" id="scheduleSendType" name="send_type">
                                    <option value="immediate">Natychmiast</option>
                                    <option value="scheduled">Zaplanowane</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleScheduledAt" class="form-label">Data wysłania</label>
                                <input type="datetime-local" class="form-control" id="scheduleScheduledAt" name="scheduled_at">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scheduleStatus" class="form-label">Status</label>
                        <select class="form-select" id="scheduleStatus" name="status">
                            <option value="active">Aktywny</option>
                            <option value="paused">Wstrzymany</option>
                            <option value="cancelled">Anulowany</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">Zapisz</button>
            </div>
        </div>
    </div>
</div>
        </div>
    </div>

    <!-- Scripts are loaded in admin/base.html -->
<script>
// Ładowanie danych przy starcie
document.addEventListener('DOMContentLoaded', function() {
    loadSchedules();
    loadTemplates();
});

// Ładowanie harmonogramów
async function loadSchedules() {
    try {
        const response = await fetch('/admin/api/schedules');
        const data = await response.json();
        
        if (data.success) {
            renderSchedulesTable(data.schedules);
        } else {
            console.error('Błąd podczas ładowania harmonogramów:', data.error);
        }
    } catch (error) {
        console.error('Błąd podczas ładowania harmonogramów:', error);
    }
}

// Ładowanie szablonów emaili
async function loadTemplates() {
    try {
        const response = await fetch('/api/email/templates');
        const templates = await response.json();
        
        const select = document.getElementById('scheduleTemplate');
        if (select) {
            // Wyczyść istniejące opcje (zachowaj pierwszą opcję "Wybierz szablon")
            select.innerHTML = '<option value="">Wybierz szablon</option>';
            
            // Dodaj szablony
            templates.forEach(template => {
                if (template.is_active) {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = `${template.name} (${template.template_type})`;
                    select.appendChild(option);
                }
            });
        }
    } catch (error) {
        console.error('Błąd podczas ładowania szablonów:', error);
    }
}

// Renderowanie tabeli harmonogramów
function renderSchedulesTable(schedules) {
    const tbody = document.getElementById('schedulesTableBody');
    tbody.innerHTML = '';
    
    schedules.forEach(schedule => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" name="itemIds" value="${schedule.id}">
            </td>
            <td><strong>${schedule.name}</strong></td>
            <td>${schedule.description || '-'}</td>
            <td>${schedule.template_id}</td>
            <td><span class="badge bg-info">${schedule.trigger_type}</span></td>
            <td><span class="badge bg-secondary">${schedule.recipient_type}</span></td>
            <td><span class="badge bg-success">${schedule.status}</span></td>
            <td>${schedule.last_sent ? new Date(schedule.last_sent).toLocaleString('pl-PL') : '-'}</td>
            <td>${schedule.sent_count || 0}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editSchedule(${schedule.id})" title="Edytuj">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteSchedule(${schedule.id})" title="Usuń">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Zapisywanie harmonogramu
async function saveSchedule() {
    const form = document.getElementById('scheduleForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/admin/api/schedules', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            window.toastManager.success('Harmonogram został zapisany pomyślnie!');
            bootstrap.Modal.getInstance(document.getElementById('addScheduleModal')).hide();
            loadSchedules();
        } else {
            window.toastManager.error('Błąd podczas zapisywania: ' + data.error);
        }
    } catch (error) {
        window.toastManager.error('Błąd podczas zapisywania: ' + error.message);
    }
}

// Edycja harmonogramu
async function editSchedule(id) {
    try {
        const response = await fetch(`/admin/api/schedules/${id}`);
        const data = await response.json();
        
        if (data.success) {
            const schedule = data.schedule;
            
            // Wypełnij formularz
            document.getElementById('scheduleId').value = schedule.id;
            document.getElementById('scheduleName').value = schedule.name;
            document.getElementById('scheduleDescription').value = schedule.description || '';
            document.getElementById('scheduleTriggerType').value = schedule.trigger_type;
            document.getElementById('scheduleRecipientType').value = schedule.recipient_type;
            
            // Załaduj szablony i ustaw wybrany
            await loadTemplates();
            document.getElementById('scheduleTemplate').value = schedule.template_id;
            
            // Pokaż modal
            const modal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
            modal.show();
        } else {
            window.toastManager.error('Błąd podczas ładowania harmonogramu: ' + data.error);
        }
    } catch (error) {
        window.toastManager.error('Błąd podczas ładowania harmonogramu: ' + error.message);
    }
}

// Usuwanie harmonogramu
async function deleteSchedule(id) {
    // Use modal confirmation instead of confirm()
    document.getElementById('bulkDeleteMessage').innerHTML = 'Czy na pewno chcesz usunąć ten harmonogram?<br><small class="text-muted">Ta operacja nie może być cofnięta.</small>';
    
    const modal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
    modal.show();
    
    // Update confirm button
    const confirmBtn = document.getElementById('confirmBulkDelete');
    confirmBtn.onclick = async function() {
        try {
            const response = await fetch(`/api/schedules/${id}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                window.toastManager.success('Harmonogram został usunięty pomyślnie!');
                loadSchedules();
            } else {
                window.toastManager.error('Błąd podczas usuwania: ' + data.error);
            }
        } catch (error) {
            window.toastManager.error('Błąd podczas usuwania: ' + error.message);
        }
        modal.hide();
    };
}

// Bulk delete functionality


// Bind bulk delete button
document.addEventListener('DOMContentLoaded', function() {
    
});
</script>
{% endblock %}
