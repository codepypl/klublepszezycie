{% extends "admin/base.html" %}

{% block title %}Czarna lista - Panel administratora{% endblock %}

{% block page_actions %}
    <div class="d-flex justify-content-end gap-2 mb-3">
        <button class="btn admin-btn" onclick="showCreateBlacklistModal()">
            <i class="fas fa-plus me-2"></i>Dodaj numer
        </button>
        <button class="btn admin-btn-secondary" onclick="showImportModal()">
            <i class="fas fa-upload me-2"></i>Import CSV/XLSX
        </button>
        <button class="btn admin-btn-danger" id="bulkDeleteBtn" style="display: none;">
            <i class="fas fa-trash me-2"></i>Usuń Zaznaczone
        </button>
    </div>
{% endblock %}

{% block extra_css %}
<style>
    .admin-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .admin-card-header {
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
    }
    
    .admin-card-body {
        padding: 20px;
    }
    
    .admin-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0;
    }
    
    .admin-table th,
    .admin-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }
    
    .admin-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    
    .admin-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .badge.bg-success {
        background-color: #28a745 !important;
        color: white;
    }
    
    .badge.bg-secondary {
        background-color: #6c757d !important;
        color: white;
    }
    
    .badge.bg-danger {
        background-color: #dc3545 !important;
        color: white;
    }
    
    .admin-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .admin-btn-primary {
        background-color: #007bff;
        color: white;
    }
    
    .admin-btn-primary:hover {
        background-color: #0056b3;
    }
    
    .admin-btn-outline {
        background-color: transparent;
        border: 1px solid #007bff;
        color: #007bff;
    }
    
    .admin-btn-outline:hover {
        background-color: #007bff;
        color: white;
    }
    
    .admin-btn-danger {
        background-color: #dc3545;
        color: white;
    }
    
    .admin-btn-danger:hover {
        background-color: #c82333;
    }
    
    .admin-btn-warning {
        background-color: #ffc107;
        color: #212529;
    }
    
    .admin-btn-warning:hover {
        background-color: #e0a800;
    }
    
    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }
    
    .form-control {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 0.875rem;
    }
    
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 8px;
    }
    
    .alert {
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .alert-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .alert-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }
    
    .card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 16px 20px;
        font-weight: 600;
    }
    
    .card-body {
        padding: 20px;
    }
    
    .btn-group .btn {
        border-radius: 0;
    }
    
    .btn-group .btn:first-child {
        border-top-left-radius: 4px;
        border-bottom-left-radius: 4px;
    }
    
    .btn-group .btn:last-child {
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
    }
    
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Filtry -->
    <div class="admin-card mb-4">
        <div class="admin-card-header">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Filtry
                <button class="btn btn-sm admin-btn-outline ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse">
                    <i class="fas fa-chevron-down" id="filtersIcon"></i>
                </button>
            </h5>
        </div>
        <div class="collapse" id="filtersCollapse">
            <div class="admin-card-body">
                <form id="filtersForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="campaignFilter" class="form-label">Kampania</label>
                            <select id="campaignFilter" class="form-select" onchange="applyFilters()">
                                <option value="">Wszystkie</option>
                                <option value="0">Globalna</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="phoneFilter" class="form-label">Numer telefonu</label>
                            <input type="text" id="phoneFilter" class="form-control" placeholder="Szukaj numeru..." onkeyup="applyFilters()">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn admin-btn me-2" onclick="loadBlacklist()">
                                <i class="fas fa-search me-1"></i>Szukaj
                            </button>
                            <button type="button" class="btn admin-btn-outline" onclick="clearFilters()">
                                <i class="fas fa-times me-1"></i>Wyczyść
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-ban me-2"></i>Czarna lista numerów
                    </h4>
                </div>
                
                <div class="admin-card-body">
                    <!-- Tabela -->
                    <div id="blacklistTableContainer">
                        <!-- Tabela będzie renderowana tutaj -->
                    </div>
                    
                    <!-- Pagination -->
                    <div id="pagination" class="mt-3 pagination-container" 
                         data-show-info="true" 
                         data-show-per-page="true" 
                         data-default-per-page="10" 
                         data-max-visible-pages="5"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Dodaj/Edytuj wpis czarnej listy -->
<div class="modal fade" id="blacklistModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="blacklistModalTitle">Dodaj numer do czarnej listy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="blacklistForm">
                    <div class="mb-3">
                        <label for="phone" class="form-label">Numer telefonu <span class="text-danger">*</span></label>
                        <input type="text" id="phone" name="phone" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="reason" class="form-label">Powód</label>
                        <textarea id="reason" name="reason" class="form-control" rows="3" placeholder="Opcjonalny opis powodu dodania do czarnej listy"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="campaign_id" class="form-label">Kampania</label>
                        <select id="campaign_id" name="campaign_id" class="form-control">
                            <option value="">Globalna czarna lista</option>
                        </select>
                        <small class="form-text text-muted">Pozostaw puste dla globalnej czarnej listy</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn admin-btn" onclick="saveBlacklistEntry()">Zapisz</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Import CSV/XLSX -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import numerów z pliku</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Format pliku:</strong> CSV lub XLSX z kolumnami:<br>
                    • <code>phone</code> (wymagane) - numer telefonu<br>
                    • <code>reason</code> (opcjonalne) - powód dodania do czarnej listy<br>
                    • <code>id_kampani</code> (opcjonalne) - ID kampanii (nadpisuje wybór poniżej)
                </div>
                <form id="importForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="importFile" class="form-label">Plik <span class="text-danger">*</span></label>
                        <input type="file" id="importFile" name="file" class="form-control" accept=".csv,.xlsx,.xls" required>
                    </div>
                    <div class="mb-3">
                        <label for="importCampaign" class="form-label">Kampania</label>
                        <select id="importCampaign" name="campaign_id" class="form-control">
                            <option value="">Globalna czarna lista</option>
                        </select>
                        <small class="form-text text-muted">Pozostaw puste dla globalnej czarnej listy</small>
                    </div>
                    <div class="mb-3">
                        <label for="importReason" class="form-label">Domyślny powód</label>
                        <input type="text" id="importReason" name="reason" class="form-control" placeholder="Import masowy">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn admin-btn" onclick="importBlacklist()">Importuj</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Potwierdzenie usunięcia -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Potwierdzenie usunięcia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Czy na pewno chcesz usunąć ten wpis z czarnej listy?</p>
                <p><strong>Numer:</strong> <span id="deletePhone"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn admin-btn-danger" onclick="confirmDelete()">Usuń</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let blacklist = [];
let paginationData = null;
let currentPage = 1;
let currentPerPage = 10;
let currentEntryId = null;
let deleteEntryId = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadCampaigns();
    loadBlacklist();
});

// Load campaigns for dropdowns
function loadCampaigns() {
    fetch('/api/crm/campaigns')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const campaignSelect = document.getElementById('campaign_id');
                const campaignFilter = document.getElementById('campaignFilter');
                const importCampaign = document.getElementById('importCampaign');
                
                // Clear existing options
                [campaignSelect, importCampaign].forEach(select => {
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                });
                
                // Add campaigns
                data.campaigns.forEach(campaign => {
                    const option = document.createElement('option');
                    option.value = campaign.id;
                    option.textContent = campaign.name;
                    
                    campaignSelect.appendChild(option.cloneNode(true));
                    importCampaign.appendChild(option.cloneNode(true));
                });
                
                // Add to filter
                data.campaigns.forEach(campaign => {
                    const option = document.createElement('option');
                    option.value = campaign.id;
                    option.textContent = campaign.name;
                    campaignFilter.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading campaigns:', error);
        });
}

// Load blacklist entries
function loadBlacklist() {
    console.log('🔍 loadBlacklist called with:', { currentPage, currentPerPage });
    
    const params = new URLSearchParams({
        page: currentPage,
        per_page: currentPerPage
    });
    
    const campaignFilter = document.getElementById('campaignFilter').value;
    const phoneFilter = document.getElementById('phoneFilter').value;
    
    if (campaignFilter !== '') {
        params.append('campaign', campaignFilter);
    }
    if (phoneFilter) {
        params.append('phone', phoneFilter);
    }
    
    console.log('🔍 API params:', params.toString());
    
    fetch(`/api/crm/admin/blacklist?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('🔍 API response:', data);
            if (data.success) {
                blacklist = data.blacklist;
                displayBlacklist();
                if (data.pagination) {
                    console.log('🔍 Calling updatePagination with:', data.pagination);
                    currentPerPage = data.pagination.per_page;
                    updatePagination(data.pagination);
                } else {
                    console.log('🔍 No pagination data in response');
                }
            } else {
                showError('Błąd podczas ładowania czarnej listy: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error loading blacklist:', error);
            showError('Błąd podczas ładowania czarnej listy');
        });
}

// Display blacklist entries
function displayBlacklist() {
    const container = document.getElementById('blacklistTableContainer');
    
    if (blacklist.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Brak wpisów w czarnej liście
            </div>
        `;
        return;
    }
    
    const tableHtml = `
        <table id="blacklistTable" class="table admin-table bulk-delete-table resizable-table" data-delete-endpoint="/api/crm/admin/blacklist/bulk-delete">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th><i class="fas fa-phone me-1"></i>Numer telefonu</th>
                    <th><i class="fas fa-comment me-1"></i>Powód</th>
                    <th><i class="fas fa-bullhorn me-1"></i>Kampania</th>
                    <th><i class="fas fa-user me-1"></i>Dodane przez</th>
                    <th><i class="fas fa-calendar me-1"></i>Data dodania</th>
                    <th><i class="fas fa-toggle-on me-1"></i>Status</th>
                    <th><i class="fas fa-cogs me-1"></i>Akcje</th>
                </tr>
            </thead>
            <tbody id="blacklistTableBody">
                ${blacklist.map(entry => `
                    <tr>
                        <td>
                            <input type="checkbox" name="itemIds" value="${entry.id}">
                        </td>
                        <td>
                            <strong>${escapeHtml(entry.phone)}</strong>
                        </td>
                        <td>
                            <span class="text-muted">${escapeHtml(entry.reason || 'Brak opisu')}</span>
                        </td>
                        <td>
                            <span class="badge ${entry.campaign_id ? 'bg-info' : 'bg-secondary'}">
                                ${entry.campaign_name}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">${escapeHtml(entry.created_by)}</small>
                        </td>
                        <td>
                            <small class="text-muted">${formatDate(entry.created_at)}</small>
                        </td>
                        <td>
                            <span class="badge ${entry.is_active ? 'bg-success' : 'bg-secondary'}">
                                ${entry.is_active ? 'Aktywny' : 'Nieaktywny'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn admin-btn-outline" onclick="editBlacklistEntry(${entry.id})" title="Edytuj">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn admin-btn-danger" onclick="deleteBlacklistEntry(${entry.id}, '${escapeHtml(entry.phone)}')" title="Usuń">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    container.innerHTML = tableHtml;
    
    // Initialize bulk delete functionality
    if (typeof BulkDelete !== 'undefined') {
        new BulkDelete('blacklistTable', '/api/crm/admin/blacklist/bulk-delete');
    }
}

// Pagination functions
function updatePagination(paginationData) {
    console.log('🔍 updatePagination called with:', paginationData);
    
    const paginationContainer = document.getElementById('pagination');
    if (paginationContainer) {
        if (paginationContainer.paginationInstance) {
            // Update existing pagination
            paginationContainer.paginationInstance.setData(paginationData);
        } else {
            // Check if SimplePagination class is available
            if (typeof SimplePagination === 'undefined') {
                console.error('SimplePagination class not available. Make sure simple-paginate.js is loaded.');
                return;
            }
            
            // Initialize pagination for the first time
            paginationContainer.paginationInstance = new SimplePagination('pagination', {
                showInfo: true,
                showPerPage: true,
                perPageOptions: [5, 10, 25, 50, 100],
                defaultPerPage: 10,
                maxVisiblePages: 5
            });
            
            // Set callbacks
            paginationContainer.paginationInstance.setPageChangeCallback((page) => {
                console.log('🔍 onPageChange called with:', page);
                currentPage = page;
                loadBlacklist();
            });
            
            paginationContainer.paginationInstance.setPerPageChangeCallback((newPage, perPage) => {
                console.log('🔍 onPerPageChange called with:', { newPage, perPage });
                currentPage = newPage;
                currentPerPage = perPage;
                console.log('🔍 Updated variables:', { currentPage, currentPerPage });
                loadBlacklist();
            });
            
            paginationContainer.paginationInstance.setData(paginationData);
        }
    } else {
        console.error('Pagination container not found');
    }
}

// Filter functions
function applyFilters() {
    currentPage = 1;
    loadBlacklist();
}

function clearFilters() {
    document.getElementById('campaignFilter').value = '';
    document.getElementById('phoneFilter').value = '';
    currentPage = 1;
    loadBlacklist();
}

// Modal functions
function showCreateBlacklistModal() {
    document.getElementById('blacklistModalTitle').textContent = 'Dodaj numer do czarnej listy';
    document.getElementById('blacklistForm').reset();
    currentEntryId = null;
    
    const modal = new bootstrap.Modal(document.getElementById('blacklistModal'));
    modal.show();
}

function editBlacklistEntry(entryId) {
    const entry = blacklist.find(e => e.id === entryId);
    if (!entry) return;
    
    document.getElementById('blacklistModalTitle').textContent = 'Edytuj wpis czarnej listy';
    document.getElementById('phone').value = entry.phone;
    document.getElementById('reason').value = entry.reason || '';
    document.getElementById('campaign_id').value = entry.campaign_id || '';
    currentEntryId = entryId;
    
    const modal = new bootstrap.Modal(document.getElementById('blacklistModal'));
    modal.show();
}

function saveBlacklistEntry() {
    const phone = document.getElementById('phone').value.trim();
    const reason = document.getElementById('reason').value.trim();
    const campaign_id = document.getElementById('campaign_id').value || null;
    
    if (!phone) {
        showError('Numer telefonu jest wymagany');
        return;
    }
    
    const data = {
        phone: phone,
        reason: reason,
        campaign_id: campaign_id
    };
    
    const url = currentEntryId 
        ? `/api/crm/admin/blacklist/${currentEntryId}`
        : '/api/crm/admin/blacklist';
    
    const method = currentEntryId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            bootstrap.Modal.getInstance(document.getElementById('blacklistModal')).hide();
            loadBlacklist();
        } else {
            showError(data.error);
        }
    })
    .catch(error => {
        console.error('Error saving blacklist entry:', error);
        showError('Błąd podczas zapisywania wpisu');
    });
}

function showImportModal() {
    document.getElementById('importForm').reset();
    
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
}

function importBlacklist() {
    const form = document.getElementById('importForm');
    const formData = new FormData(form);
    
    fetch('/api/crm/admin/blacklist/import', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            loadBlacklist();
        } else {
            showError(data.error);
        }
    })
    .catch(error => {
        console.error('Error importing blacklist:', error);
        showError('Błąd podczas importu');
    });
}

function deleteBlacklistEntry(entryId, phone) {
    deleteEntryId = entryId;
    document.getElementById('deletePhone').textContent = phone;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function confirmDelete() {
    if (!deleteEntryId) return;
    
    fetch(`/api/crm/admin/blacklist/${deleteEntryId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            loadBlacklist();
        } else {
            showError(data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting blacklist entry:', error);
        showError('Błąd podczas usuwania wpisu');
    });
    
    deleteEntryId = null;
}


// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('pl-PL', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showSuccess(message) {
    // Use toast notification if available
    if (window.toastManager) {
        window.toastManager.success(message);
    } else {
        alert(message);
    }
}

function showError(message) {
    // Use toast notification if available
    if (window.toastManager) {
        window.toastManager.error(message);
    } else {
        alert(message);
    }
}
</script>
{% endblock %}
