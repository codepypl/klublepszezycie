{% extends "admin/base.html" %}

{% block title %}Zarządzanie kampaniami - {{ super() }}{% endblock %}

{% block page_title %}
    <i class="fas fa-bullhorn me-2"></i>Zarządzanie kampaniami
{% endblock %}

{% block page_actions %}
    <div class="d-flex justify-content-end gap-2 mb-3">
        <button class="btn admin-btn" onclick="showCreateCampaignModal()">
            <i class="fas fa-plus me-2"></i>Nowa kampania
        </button>
    </div>
{% endblock %}

{% block content %}
<!-- Campaign Management Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="admin-card">
            <div class="admin-card-body">
                <div class="mb-3">
                    <button class="btn admin-btn-danger" id="bulkDeleteBtn" style="display: none;">
                        <i class="fas fa-trash me-2"></i>Usuń Zaznaczone
                    </button>
                </div>
                <div id="campaignsTableContainer">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Ładowanie...</span>
                        </div>
                        <p class="mt-2 text-muted">Ładowanie kampanii...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Campaign Modal -->
<div class="modal fade" id="campaignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="campaignModalTitle">
                    <i class="fas fa-bullhorn me-2"></i>Nowa kampania
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="campaignForm">
                    <input type="hidden" id="campaignId" name="campaignId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="campaignName" class="form-label">
                                    <i class="fas fa-tag me-1"></i>Nazwa kampanii *
                                </label>
                                <input type="text" class="form-control" id="campaignName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="campaignStatus" class="form-label">
                                    <i class="fas fa-toggle-on me-1"></i>Status
                                </label>
                                <select class="form-select" id="campaignStatus" name="is_active">
                                    <option value="true">Aktywna</option>
                                    <option value="false">Nieaktywna</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="campaignDescription" class="form-label">
                            <i class="fas fa-info-circle me-1"></i>Opis kampanii
                        </label>
                        <textarea class="form-control" id="campaignDescription" name="description" rows="3" placeholder="Krótki opis kampanii..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="campaignScript" class="form-label">
                            <i class="fas fa-file-alt me-1"></i>Skrypt rozmowy
                        </label>
                        <textarea class="form-control" id="campaignScript" name="script_content" data-quill placeholder="Skrypt dla ankieterów..."></textarea>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Ten skrypt będzie widoczny dla ankieterów podczas rozmów z kontaktami z tej kampanii.
                            Użyj edytora aby sformatować tekst, dodać listy, pogrubienia itp.
                        </div>
                        
                        <!-- Available Variables -->
                        <div class="mt-3">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-code me-2"></i>Dostępne zmienne
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary">Dane kontaktu:</h6>
                                            <ul class="list-unstyled">
                                                <li><code>[IMIĘ_NAZWISKO]</code> - Imię i nazwisko kontaktu</li>
                                                <li><code>[FIRMA]</code> - Nazwa firmy</li>
                                                <li><code>[TELEFON]</code> - Numer telefonu</li>
                                                <li><code>[EMAIL]</code> - Adres email</li>
                                                <li><code>[TAGI]</code> - Tagi przypisane do kontaktu</li>
                                                <li><code>[NOTATKI]</code> - Notatki o kontakcie</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-primary">Dane agenta:</h6>
                                            <ul class="list-unstyled">
                                                <li><code>[AGENT_IMIĘ]</code> - Imię ankietera</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="alert alert-warning mt-2">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Uwaga:</strong> Zmienne będą automatycznie zastąpione odpowiednimi danymi podczas rozmowy.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn admin-btn-outline" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Anuluj
                </button>
                <button type="button" class="btn admin-btn" onclick="saveCampaign()">
                    <i class="fas fa-save me-2"></i>Zapisz kampanię
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Campaign Confirmation Modal -->
<div class="modal fade" id="deleteCampaignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>Potwierdzenie usunięcia
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Uwaga!</strong> Ta operacja jest nieodwracalna.
                </div>
                <p>Czy na pewno chcesz usunąć kampanię <strong id="deleteCampaignName"></strong>?</p>
                <div id="deleteCampaignWarning" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-ban me-2"></i>
                    <span id="deleteCampaignWarningText"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn admin-btn-outline" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Anuluj
                </button>
                <button type="button" class="btn admin-btn-danger" id="confirmDeleteCampaignBtn">
                    <i class="fas fa-trash me-2"></i>Usuń kampanię
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Campaign Records Confirmation Modal -->
<div class="modal fade" id="deleteRecordsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-users-slash me-2"></i>Usuń rekordy z kampanii
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Czy na pewno chcesz usunąć <strong>wszystkie rekordy</strong> z kampanii <strong id="deleteRecordsCampaignName"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Uwaga:</strong> Ta operacja usunie wszystkie kontakty przypisane do tej kampanii. 
                    Ta akcja jest nieodwracalna!
                </div>
                <p>Liczba rekordów do usunięcia: <span id="deleteRecordsCount" class="badge bg-danger"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn admin-btn-outline" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Anuluj
                </button>
                <button type="button" class="btn admin-btn-danger" id="confirmDeleteRecordsBtn">
                    <i class="fas fa-users-slash me-2"></i>Usuń wszystkie rekordy
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
.ql-editor {
    font-size: 14px;
    line-height: 1.5;
}
.ql-toolbar {
    border-top: 1px solid #ccc;
    border-left: 1px solid #ccc;
    border-right: 1px solid #ccc;
    border-bottom: none;
}
.ql-container {
    border-bottom: 1px solid #ccc;
    border-left: 1px solid #ccc;
    border-right: 1px solid #ccc;
    border-top: none;
}
.ql-toolbar .ql-formats {
    margin-right: 15px;
}
</style>
{% endblock %}


<script>
let campaigns = [];
let paginationData = null;
let currentPage = 1;
let currentPerPage = 10;
let currentCampaignId = null;

// Load campaigns on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCampaigns();
});


function loadCampaigns() {
    console.log('🔍 loadCampaigns called with:', { currentPage, currentPerPage });
    
    const params = new URLSearchParams({
        page: currentPage,
        per_page: currentPerPage
    });
    
    console.log('🔍 API params:', params.toString());
    
    fetch(`/api/crm/admin/campaigns?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('🔍 API response:', data);
            if (data.success) {
                campaigns = data.campaigns;
                displayCampaigns();
                if (data.pagination) {
                    console.log('🔍 Calling updatePagination with:', data.pagination);
                    // Update currentPerPage from server response
                    currentPerPage = data.pagination.per_page;
                    updatePagination(data.pagination);
                } else {
                    console.log('🔍 No pagination data in response');
                }
            } else {
                showError('Błąd podczas ładowania kampanii: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error loading campaigns:', error);
            showError('Błąd podczas ładowania kampanii');
        });
}

function displayCampaigns() {
    const container = document.getElementById('campaignsTableContainer');
    
    if (campaigns.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-bullhorn fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Brak kampanii</h5>
                <p class="text-muted">Utwórz pierwszą kampanię, aby rozpocząć zarządzanie kontaktami.</p>
                <button type="button" class="btn admin-btn" onclick="showCreateCampaignModal()">
                    <i class="fas fa-plus me-2"></i>Utwórz pierwszą kampanię
                </button>
            </div>
        `;
        return;
    }
    
    const tableHTML = `
        <div class="table-responsive">
            <table id="campaignsTable" class="table admin-table bulk-delete-table resizable-table" data-delete-endpoint="/api/crm/admin/campaigns/bulk-delete">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll">
                        </th>
                        <th>Nazwa</th>
                        <th>Importy</th>
                        <th>Kontakty</th>
                        <th>Połączenia</th>
                        <th>Data utworzenia</th>
                        <th>Status</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody id="campaignsTableBody">
                    ${campaigns.map(campaign => `
                        <tr>
                            <td>
                                <input type="checkbox" name="itemIds" value="${campaign.id}">
                            </td>
                            <td>
                                <strong>${escapeHtml(campaign.name)}</strong>
                            </td>
                            <td>
                                <span class="badge bg-info">${campaign.import_files_count}</span>
                            </td>
                            <td>
                                <span class="badge bg-primary">${campaign.contacts_count}</span>
                            </td>
                            <td>
                                <span class="badge bg-secondary">${campaign.calls_count}</span>
                            </td>
                            <td>
                                <small class="text-muted">${formatDate(campaign.created_at)}</small>
                            </td>
                            <td>
                                <span class="badge ${campaign.is_active ? 'bg-success' : 'bg-secondary'}">
                                    ${campaign.is_active ? 'Aktywna' : 'Nieaktywna'}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn admin-btn-outline" onclick="editCampaign(${campaign.id})" title="Edytuj">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn ${campaign.is_active ? 'admin-btn-warning' : 'admin-btn-info'}" onclick="toggleCampaignStatus(${campaign.id}, ${campaign.is_active})" title="${campaign.is_active ? 'Dezaktywuj' : 'Aktywuj'}">
                                        <i class="fas fa-toggle-${campaign.is_active ? 'on' : 'off'}"></i>
                                    </button>
                                    <button type="button" class="btn admin-btn-danger" onclick="deleteCampaignRecords(${campaign.id}, '${escapeHtml(campaign.name)}', ${campaign.contacts_count})" title="Usuń rekordy">
                                        <i class="fas fa-users-slash"></i>
                                    </button>
                                    <button type="button" class="btn admin-btn-danger" onclick="deleteCampaign(${campaign.id}, '${escapeHtml(campaign.name)}', ${campaign.contacts_count}, ${campaign.calls_count})" title="Usuń kampanię">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div id="pagination" class="mt-3 pagination-container" 
             data-show-info="true" 
             data-show-per-page="true" 
             data-default-per-page="10" 
             data-max-visible-pages="5"></div>
    `;
    
    container.innerHTML = tableHTML;
    
    // Initialize bulk delete functionality
    if (typeof BulkDelete !== 'undefined') {
        new BulkDelete('campaignsTable', '/api/crm/admin/campaigns/bulk-delete');
    }
}

function updatePagination(paginationData) {
    console.log('🔍 updatePagination called with:', paginationData);
    
    const paginationContainer = document.getElementById('pagination');
    if (paginationContainer) {
        if (paginationContainer.paginationInstance) {
            // Update existing pagination
            paginationContainer.paginationInstance.setData(paginationData);
        } else {
            // Check if SimplePagination class is available
            if (typeof SimplePagination === 'undefined') {
                console.error('SimplePagination class not available. Make sure simple-paginate.js is loaded.');
                return;
            }
            
            // Initialize pagination for the first time
            paginationContainer.paginationInstance = new SimplePagination('pagination', {
                showInfo: true,
                showPerPage: true,
                perPageOptions: [5, 10, 25, 50, 100],
                defaultPerPage: 10,
                maxVisiblePages: 5
            });
            
            // Set callbacks
            paginationContainer.paginationInstance.setPageChangeCallback((page) => {
                console.log('🔍 onPageChange called with:', page);
                currentPage = page;
                loadCampaigns();
            });
            
            paginationContainer.paginationInstance.setPerPageChangeCallback((newPage, perPage) => {
                console.log('🔍 onPerPageChange called with:', { newPage, perPage });
                currentPage = newPage;
                currentPerPage = perPage;
                console.log('🔍 Updated variables:', { currentPage, currentPerPage });
                loadCampaigns();
            });
            
            paginationContainer.paginationInstance.setData(paginationData);
        }
    } else {
        console.error('Pagination container not found');
    }
}

function showCreateCampaignModal() {
    currentCampaignId = null;
    document.getElementById('campaignModalTitle').innerHTML = '<i class="fas fa-bullhorn me-2"></i>Nowa kampania';
    document.getElementById('campaignForm').reset();
    document.getElementById('campaignStatus').value = 'true';
    document.getElementById('campaignId').value = '';
    
    // Clear script content
    document.getElementById('campaignScript').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('campaignModal'));
    modal.show();
}

function editCampaign(campaignId) {
    const campaign = campaigns.find(c => c.id === campaignId);
    if (!campaign) return;
    
    currentCampaignId = campaignId;
    document.getElementById('campaignModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edytuj kampanię';
    document.getElementById('campaignId').value = campaignId;
    document.getElementById('campaignName').value = campaign.name;
    document.getElementById('campaignDescription').value = campaign.description || '';
    document.getElementById('campaignScript').value = campaign.script_content || '';
    document.getElementById('campaignStatus').value = campaign.is_active.toString();
    
    const modal = new bootstrap.Modal(document.getElementById('campaignModal'));
    modal.show();
}

function saveCampaign() {
    // Get content from script textarea
    const scriptContent = document.getElementById('campaignScript').value;
    
    const formData = {
        name: document.getElementById('campaignName').value.trim(),
        description: document.getElementById('campaignDescription').value.trim(),
        script_content: scriptContent,
        is_active: document.getElementById('campaignStatus').value === 'true'
    };
    
    if (!formData.name) {
        showError('Nazwa kampanii jest wymagana');
        return;
    }
    
    const url = currentCampaignId 
        ? `/api/crm/admin/campaigns/${currentCampaignId}`
        : '/api/crm/admin/campaigns';
    
    const method = currentCampaignId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            bootstrap.Modal.getInstance(document.getElementById('campaignModal')).hide();
            loadCampaigns();
        } else {
            showError('Błąd: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving campaign:', error);
        showError('Błąd podczas zapisywania kampanii');
    });
}

function toggleCampaignStatus(campaignId, currentStatus) {
    fetch(`/api/crm/admin/campaigns/${campaignId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadCampaigns();
        } else {
            showError('Błąd: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error toggling campaign status:', error);
        showError('Błąd podczas zmiany statusu kampanii');
    });
}

function deleteCampaign(campaignId, campaignName, contactsCount, callsCount) {
    const nameElement = document.getElementById('deleteCampaignName');
    const warningDiv = document.getElementById('deleteCampaignWarning');
    const warningText = document.getElementById('deleteCampaignWarningText');
    const confirmBtn = document.getElementById('confirmDeleteCampaignBtn');
    const modal = document.getElementById('deleteCampaignModal');
    
    // Check if all required elements exist
    if (!nameElement || !warningDiv || !warningText || !confirmBtn || !modal) {
        console.error('Required elements for deleteCampaign modal not found');
        alert('Błąd: Nie można załadować modala usuwania kampanii');
        return;
    }
    
    nameElement.textContent = campaignName;
    
    if (contactsCount > 0 || callsCount > 0) {
        warningDiv.style.display = 'block';
        warningText.textContent = `Nie można usunąć kampanii. Jest powiązana z ${contactsCount} kontaktami i ${callsCount} połączeniami.`;
        confirmBtn.disabled = true;
    } else {
        warningDiv.style.display = 'none';
        confirmBtn.disabled = false;
    }
    
    // Set up confirm button
    confirmBtn.onclick = function() {
        confirmDeleteCampaign(campaignId);
    };
    
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

function confirmDeleteCampaign(campaignId) {
    fetch(`/api/crm/admin/campaigns/${campaignId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            bootstrap.Modal.getInstance(document.getElementById('deleteCampaignModal')).hide();
            loadCampaigns();
        } else {
            showError('Błąd: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting campaign:', error);
        showError('Błąd podczas usuwania kampanii');
    });
}

// Delete campaign records
function deleteCampaignRecords(campaignId, campaignName, recordsCount) {
    const nameElement = document.getElementById('deleteRecordsCampaignName');
    const countElement = document.getElementById('deleteRecordsCount');
    const modal = document.getElementById('deleteRecordsModal');
    const confirmBtn = document.getElementById('confirmDeleteRecordsBtn');
    
    // Check if all required elements exist
    if (!nameElement || !countElement || !modal || !confirmBtn) {
        console.error('Required elements for deleteRecords modal not found');
        alert('Błąd: Nie można załadować modala usuwania rekordów');
        return;
    }
    
    nameElement.textContent = campaignName;
    countElement.textContent = recordsCount;
    
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // Handle confirmation
    confirmBtn.onclick = function() {
        fetch(`/api/crm/admin/campaigns/${campaignId}/delete-records`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                bootstrap.Modal.getInstance(document.getElementById('deleteRecordsModal')).hide();
                loadCampaigns();
            } else {
                showError('Błąd: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting campaign records:', error);
            showError('Błąd podczas usuwania rekordów z kampanii');
        });
    };
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('pl-PL') + ' ' + date.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
}

function showSuccess(message) {
    if (window.toastManager) {
        window.toastManager.show(message, 'success');
    } else {
        alert(message);
    }
}

function showError(message) {
    if (window.toastManager) {
        window.toastManager.show(message, 'error');
    } else {
        alert(message);
    }
}

</script>
{% endblock %}
