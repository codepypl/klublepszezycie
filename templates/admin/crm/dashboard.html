{% extends "admin/base.html" %}

{% block title %}Statystyki CRM - {{ super() }}{% endblock %}

{% block page_title %}
    <i class="fas fa-chart-bar me-2"></i>Statystyki CRM
{% endblock %}

{% block page_actions %}
    <div class="d-flex justify-content-end gap-2 mb-3">
        <button class="btn admin-btn-outline" onclick="refreshDashboard()" id="refreshBtn">
            <i class="fas fa-sync me-2"></i>Od≈õwie≈º
        </button>
    </div>
{% endblock %}

{% block content %}
    <!-- Stats Cards - Dzienne (zerowanie ka≈ºdego dnia) -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-star"></i>
                <h3 id="leadsToday">0</h3>
                <p>Leady (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-phone"></i>
                <h3 id="answeredToday">0</h3>
                <p>Odebrane (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-phone-slash"></i>
                <h3 id="notAnsweredToday">0</h3>
                <p>Nieodebrane (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-calendar-plus"></i>
                <h3 id="callbacksToday">0</h3>
                <p>Prze≈Ço≈ºenia (dzisiaj)</p>
            </div>
        </div>
    </div>

    <!-- Stats Cards - ≈ÅƒÖczne -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-phone-alt"></i>
                <h3 id="totalAnswered">0</h3>
                <p>Odebrane ≈ÇƒÖcznie</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-phone-slash"></i>
                <h3 id="totalNotAnswered">0</h3>
                <p>Nieodebrane ≈ÇƒÖcznie</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-redo"></i>
                <h3 id="totalCallbacks">0</h3>
                <p>≈ÅƒÖczna liczba recalli</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-clock"></i>
                <h3 id="longestCallToday">0:00</h3>
                <p>Najd≈Çu≈ºsza rozmowa (dzisiaj)</p>
            </div>
        </div>
    </div>

    <!-- Stats Cards - Czasowe -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-stopwatch"></i>
                <h3 id="avgCallTime">0:00</h3>
                <p>≈örednia rozmowa (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-chart-line"></i>
                <h3 id="successRate">0%</h3>
                <p>Wska≈∫nik sukcesu</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-list"></i>
                <h3 id="queueCount">0</h3>
                <p>W kolejce</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-users"></i>
                <h3 id="totalContacts">0</h3>
                <p>Wszystkie kontakty</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5><i class="fas fa-bolt me-2"></i>Funkcje CRM</h5>
                </div>
                <div class="admin-card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('crm.calls') }}" class="btn admin-btn w-100">
                                <i class="fas fa-phone me-2"></i>ZarzƒÖdzaj po≈ÇƒÖczeniami
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('crm.contacts') }}" class="btn admin-btn-secondary w-100">
                                <i class="fas fa-address-book me-2"></i>ZarzƒÖdzaj kontaktami
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="#" class="btn admin-btn-outline w-100" onclick="showInfo('Funkcja w trakcie rozwoju')">
                                <i class="fas fa-upload me-2"></i>Importuj plik CSV
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let dashboardRefreshInterval;

// Load statistics from API
async function loadDashboardStats() {
    try {
        const response = await fetch('/api/crm/agent/queue-status');
        const data = await response.json();
        
        if (data.success) {
            // Today's statistics
            document.getElementById('leadsToday').textContent = data.today_stats.leads || 0;
            document.getElementById('answeredToday').textContent = (data.today_stats.leads || 0) + (data.today_stats.rejections || 0) + (data.today_stats.callbacks || 0);
            document.getElementById('notAnsweredToday').textContent = (data.today_stats.no_answer || 0) + (data.today_stats.busy || 0) + (data.today_stats.wrong_number || 0);
            document.getElementById('callbacksToday').textContent = data.today_stats.callbacks || 0;
            
            // Total statistics
            document.getElementById('totalAnswered').textContent = (data.total_stats.leads || 0) + (data.total_stats.rejections || 0) + (data.total_stats.callbacks || 0);
            document.getElementById('totalNotAnswered').textContent = (data.total_stats.no_answer || 0) + (data.total_stats.busy || 0) + (data.total_stats.wrong_number || 0);
            document.getElementById('totalCallbacks').textContent = data.total_stats.callbacks || 0;
            
            // Time statistics
            document.getElementById('longestCallToday').textContent = formatDuration(data.today_stats.longest_call_seconds || 0);
            document.getElementById('avgCallTime').textContent = formatDuration(data.today_stats.avg_call_time_seconds || 0);
            
            // Calculate success rate
            const totalCalls = (data.today_stats.leads || 0) + (data.today_stats.rejections || 0) + 
                              (data.today_stats.callbacks || 0) + (data.today_stats.no_answer || 0) + 
                              (data.today_stats.busy || 0) + (data.today_stats.wrong_number || 0);
            const successRate = totalCalls > 0 ? Math.round((data.today_stats.leads || 0) / totalCalls * 100) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
            
            // Queue count
            const queueCount = (data.queue.callbacks || 0) + (data.queue.potentials || 0) + (data.queue.new_contacts || 0);
            document.getElementById('queueCount').textContent = queueCount;
            
            // Total contacts
            document.getElementById('totalContacts').textContent = data.total_contacts || 0;
        } else {
            console.error('Error loading dashboard stats:', data.error);
        }
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

function formatDuration(seconds) {
    if (!seconds || seconds < 0) return '0:00';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

// Refresh dashboard manually
function refreshDashboard() {
    loadDashboardStats();
}

// Auto-refresh is now handled by refreshAfterCRUD() system

// Load stats on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    loadDashboardStats();
    
    // Global refresh system will handle auto-refresh
    console.log('üîÑ CRM Dashboard initialized - global refresh system will handle updates');
});
</script>
{% endblock %}
