{% extends "admin/base.html" %}

{% block title %}Logi E-maili - Panel Admin{% endblock %}

{% block page_title %}
    <i class="fas fa-file-alt me-2"></i>Logi E-maili
{% endblock %}

{% block page_actions %}
    <div class="d-flex justify-content-end gap-2 mb-3">
        <button class="btn admin-btn-secondary" onclick="refreshLogs()">
            <i class="fas fa-sync me-2"></i>Odśwież
        </button>
        <button class="btn admin-btn-warning" onclick="clearOldLogs()">
            <i class="fas fa-trash me-2"></i>Wyczyść stare logi
        </button>
    </div>
{% endblock %}

{% block content %}
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <div class="admin-stats-card-body">
                    <div class="admin-stats-card-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="admin-stats-card-content">
                        <h3 id="totalLogs">{{ stats.total_emails if stats else 0 }}</h3>
                        <p>Wszystkie logi</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <div class="admin-stats-card-body">
                    <div class="admin-stats-card-icon">
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <div class="admin-stats-card-content">
                        <h3 id="sentLogs">{{ stats.status_breakdown.sent if stats and stats.status_breakdown else 0 }}</h3>
                        <p>Wysłane</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <div class="admin-stats-card-body">
                    <div class="admin-stats-card-icon">
                        <i class="fas fa-times-circle text-danger"></i>
                    </div>
                    <div class="admin-stats-card-content">
                        <h3 id="failedLogs">{{ stats.status_breakdown.failed if stats and stats.status_breakdown else 0 }}</h3>
                        <p>Nieudane</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <div class="admin-stats-card-body">
                    <div class="admin-stats-card-icon">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                    </div>
                    <div class="admin-stats-card-content">
                        <h3 id="bouncedLogs">{{ stats.status_breakdown.bounced if stats and stats.status_breakdown else 0 }}</h3>
                        <p>Odrzucone</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="admin-card mb-4">
        <div class="admin-card-body">
            <div class="row">
                <div class="col-md-3">
                    <label for="searchInput" class="form-label">Szukaj</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Email, temat, błąd...">
                </div>
                <div class="col-md-2">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="all">Wszystkie</option>
                        <option value="sent">Wysłane</option>
                        <option value="failed">Nieudane</option>
                        <option value="bounced">Odrzucone</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="eventIdFilter" class="form-label">ID Wydarzenia</label>
                    <input type="number" class="form-control" id="eventIdFilter" placeholder="ID wydarzenia">
                </div>
                <div class="col-md-2">
                    <label for="templateIdFilter" class="form-label">ID Szablonu</label>
                    <input type="number" class="form-control" id="templateIdFilter" placeholder="ID szablonu">
                </div>
                <div class="col-md-3">
                    <label for="campaignIdFilter" class="form-label">ID Kampanii</label>
                    <input type="number" class="form-control" id="campaignIdFilter" placeholder="ID kampanii">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-2">
                    <label for="dateFrom" class="form-label">Od</label>
                    <input type="date" class="form-control" id="dateFrom">
                </div>
                <div class="col-md-2">
                    <label for="dateTo" class="form-label">Do</label>
                    <input type="date" class="form-control" id="dateTo">
                </div>
                <div class="col-md-2">
                    <label for="timeFrom" class="form-label">Godzina od</label>
                    <input type="time" class="form-control" id="timeFrom">
                </div>
                <div class="col-md-2">
                    <label for="timeTo" class="form-label">Godzina do</label>
                    <input type="time" class="form-control" id="timeTo">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn admin-btn me-2" onclick="searchLogs()">
                        <i class="fas fa-search me-2"></i>Szukaj
                    </button>
                    <button class="btn admin-btn-outline" onclick="clearFilters()">
                        <i class="fas fa-times me-2"></i>Wyczyść filtry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Table -->
    <div class="admin-card">
        <div class="admin-card-body">
            <div class="table-responsive">
                <table id="logsTable" class="table admin-table resizable-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Wydarzenie</th>
                            <th>Status</th>
                            <th>Wysłano</th>
                            <th>Błąd</th>
                            <th>ID Szablonu</th>
                            <th>ID Kampanii</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <tr>
                            <td colspan="9" class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>Ładowanie...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div id="pagination" class="mt-3 pagination-container" 
                 data-show-info="true" 
                 data-show-per-page="true" 
                 data-default-per-page="20" 
                 data-max-visible-pages="5"></div>
        </div>
    </div>

    <!-- Log Details Modal -->
    <div class="modal fade" id="logDetailsModal" tabindex="-1" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logDetailsModalLabel">Szczegóły logu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="logDetailsContent">
                        <!-- Log details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn admin-btn-outline" data-bs-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Delete Confirmation Modal -->
    <div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkDeleteModalLabel">Potwierdzenie czyszczenia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="bulkDeleteMessage">
                        <!-- Message will be set dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn admin-btn-outline" data-bs-dismiss="modal">Anuluj</button>
                    <button type="button" class="btn admin-btn-danger" id="confirmBulkDelete">Potwierdź</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/utils/simple-paginate.js') }}?v={{ range(1000000, 9999999) | random }}"></script>
<script src="{{ url_for('static', filename='js/admin/email_logs.js') }}?v={{ range(1000000, 9999999) | random }}"></script>
{% endblock %}


