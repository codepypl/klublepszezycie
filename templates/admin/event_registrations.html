{% extends "admin/base.html" %}

{% block title %}Rejestracje na wydarzenia{% endblock %}

{% block page_title %}
    <i class="fas fa-calendar-check me-2"></i>Rejestracje na wydarzenia
{% endblock %}

{% block page_actions %}
    <div class="d-flex justify-content-end gap-2 mb-3">
        <button class="btn admin-btn" onclick="exportEventRegistrations()">
            <i class="fas fa-download me-2"></i>
            Eksportuj
        </button>
        <button class="btn admin-btn-danger" id="bulkDeleteBtn" style="display: none;">
            <i class="fas fa-trash me-2"></i>
            Usuń Zaznaczone
        </button>
    </div>
{% endblock %}

{% block content %}

    <!-- Filtry -->
    <div class="admin-card mb-4">
        <div class="admin-card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Filtry i wyszukiwanie
                </h5>
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse">
                    <i class="fas fa-chevron-down me-1"></i>Rozwiń
                </button>
            </div>
        </div>
        <div class="collapse" id="filtersCollapse">
            <div class="admin-card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="searchFilter" class="form-label">Szukaj</label>
                        <input type="text" class="form-control" id="searchFilter" placeholder="Imię, email, telefon...">
                    </div>
                    <div class="col-md-4">
                        <label for="eventFilter" class="form-label">Wydarzenie</label>
                        <select class="form-select" id="eventFilter">
                            <option value="">Wszystkie wydarzenia</option>
                            {% for event in events %}
                            <option value="{{ event.id }}">{{ event.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="dateFilter" class="form-label">Data od</label>
                        <input type="date" class="form-control" id="dateFilter">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-secondary btn-sm" onclick="clearFilters()">
                            <i class="fas fa-times me-1"></i>Wyczyść filtry
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registrations Table -->
    <div class="admin-card">
        <div class="admin-card-body">
            {% if event_registrations %}
            <div class="table-responsive">
                <table class="table admin-table bulk-delete-table" id="eventRegistrationsTable" data-delete-endpoint="/api/bulk-delete/registrations">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll">
                            </th>
                            <th>ID</th>
                            <th>Wydarzenie</th>
                            <th>Imię</th>
                            <th>Email</th>
                            <th>Telefon</th>
                            <th>Klub</th>
                            <th>Data rejestracji</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for registration in event_registrations %}
                        <tr data-event-id="{{ registration.event_id }}" data-registration-id="{{ registration.id }}">
                            <td>
                                <input type="checkbox" name="itemIds" value="{{ registration.id }}">
                            </td>
                            <td>{{ registration.id }}</td>
                            <td>
                                <strong>{{ registration.event.title if registration.event else 'Brak wydarzenia' }}</strong>
                                <br>
                                <small class="text-muted">
                                    {{ registration.event.event_date.strftime('%d.%m.%Y %H:%M') if registration.event and registration.event.event_date else 'Brak daty' }}
                                </small>
                            </td>
                            <td>
                                <strong>{{ registration.first_name }}</strong>
                                <br>
                                <small class="text-muted">
                                    <a href="{{ url_for('users.index') }}?edit_user={{ registration.email }}" class="text-decoration-none">
                                        <i class="fas fa-user-edit me-1"></i>Edytuj konto
                                    </a>
                                </small>
                            </td>
                            <td>
                                <a href="mailto:{{ registration.email }}" class="text-decoration-none">
                                    {{ registration.email }}
                                </a>
                            </td>
                            <td>{{ registration.phone or 'Brak' }}</td>
                            <td>
                                {% if registration.wants_club_news %}
                                <span class="badge bg-success">Tak</span>
                                {% else %}
                                <span class="badge bg-secondary">Nie</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ registration.created_at.strftime('%d.%m.%Y %H:%M') if registration.created_at else 'Brak' }}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm admin-btn-danger" onclick="deleteRegistration({{ registration.id }})" title="Usuń rejestrację">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Registrations Info -->
            <!-- Pagination -->
            <div id="pagination" class="mt-4 pagination-container" 
                 data-show-info="true" 
                 data-show-per-page="true" 
                 data-default-per-page="10" 
                 data-max-visible-pages="5"></div>
            
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-user-plus fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Brak rejestracji</h5>
                <p class="text-muted">Nie ma jeszcze żadnych rejestracji na wydarzenia</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Filtrowanie tabeli
document.addEventListener('DOMContentLoaded', function() {
            const eventFilter = document.getElementById('eventFilter');
        const dateFilter = document.getElementById('dateFilter');
        const searchFilter = document.getElementById('searchFilter');
        
        function filterTable() {
            const eventValue = eventFilter.value;
            const dateValue = dateFilter.value;
            const searchValue = searchFilter.value.toLowerCase();
            
            const rows = document.querySelectorAll('#eventRegistrationsTable tbody tr');
            
            rows.forEach(row => {
                let show = true;
                
                // Filtrowanie po wydarzeniu
                if (eventValue && row.dataset.eventId !== eventValue) {
                    show = false;
                }
                
                // Filtrowanie po dacie
                if (dateValue) {
                    const registrationDate = row.querySelector('td:nth-child(8)').textContent;
                    if (!registrationDate.includes(dateValue.split('-')[2])) {
                        show = false;
                    }
                }
                
                // Filtrowanie po tekście (imię, email, telefon)
                if (searchValue) {
                    const name = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                    const email = row.querySelector('td:nth-child(5)').textContent.toLowerCase();
                    const phone = row.querySelector('td:nth-child(6)').textContent.toLowerCase();
                    if (!name.includes(searchValue) && !email.includes(searchValue) && !phone.includes(searchValue)) {
                        show = false;
                    }
                }
                
                row.style.display = show ? '' : 'none';
            });
        }
        
        eventFilter.addEventListener('change', filterTable);
        dateFilter.addEventListener('change', filterTable);
        searchFilter.addEventListener('input', filterTable);
        
        // Obsługa przycisku rozwijania/zwijania filtrów
        const filtersCollapse = document.getElementById('filtersCollapse');
        const toggleButton = document.querySelector('[data-bs-target="#filtersCollapse"]');
        const chevronIcon = toggleButton.querySelector('i');
        
        filtersCollapse.addEventListener('show.bs.collapse', function () {
            chevronIcon.className = 'fas fa-chevron-up me-1';
            toggleButton.innerHTML = '<i class="fas fa-chevron-up me-1"></i>Zwiń';
        });
        
        filtersCollapse.addEventListener('hide.bs.collapse', function () {
            chevronIcon.className = 'fas fa-chevron-down me-1';
            toggleButton.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Rozwiń';
        });
        
        // Set up pagination handlers for auto-initialization
        {% if pagination %}
        window.flaskPaginationData = {
            page: {{ pagination.page }},
            pages: {{ pagination.pages }},
            total: {{ pagination.total }},
            per_page: {{ pagination.per_page }}
        };
        
        window.paginationHandlers = {
            onPageChange: (page) => {
                const url = new URL(window.location);
                url.searchParams.set('page', page);
                const perPage = {{ pagination.per_page if pagination else 10 }};
                url.searchParams.set('per_page', perPage);
                window.location.href = url.toString();
            },
            onPerPageChange: (newPage, perPage) => {
                const url = new URL(window.location);
                url.searchParams.set('page', newPage);
                url.searchParams.set('per_page', perPage);
                window.location.href = url.toString();
            }
        };
        {% endif %}
});





// Usuń rejestrację
function deleteRegistration(registrationId) {
    if (confirm('Czy na pewno chcesz usunąć tę rejestrację? Tej operacji nie można cofnąć.')) {
        fetch(`/admin/api/event-registration/${registrationId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Rejestracja została usunięta', 'success');
                // Usuń wiersz z tabeli
                const row = document.querySelector(`tr[data-registration-id="${registrationId}"]`);
                if (row) {
                    row.remove();
                }
            } else {
                showNotification('Błąd podczas usuwania: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Wystąpił błąd podczas usuwania', 'error');
        });
    }
}

// Eksport rejestracji
function exportEventRegistrations() {
    const table = document.getElementById('eventRegistrationsTable');
    const rows = Array.from(table.querySelectorAll('tbody tr:not([style*="display: none"])'));
    
    let csv = 'ID,Wydarzenie,Imię,Email,Telefon,Klub,Data rejestracji\n';
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const eventTitle = cells[1].querySelector('strong') ? cells[1].querySelector('strong').textContent : 'Brak';
        const eventDate = cells[1].querySelector('small') ? cells[1].querySelector('small').textContent : 'Brak';
        const name = cells[2].querySelector('strong') ? cells[2].querySelector('strong').textContent : 'Brak';
        const email = cells[3].textContent;
        const phone = cells[4].textContent;
        const club = cells[5].textContent.includes('Tak') ? 'Tak' : 'Nie';
        const date = cells[6].textContent;
        
        csv += `"${eventTitle}","${eventDate}","${name}","${email}","${phone}","${club}","${date}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `rejestracje_na_wydarzenia_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Funkcja powiadomień
function showNotification(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
    </script>
{% endblock %}