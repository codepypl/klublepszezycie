{% extends "admin/base.html" %}

{% block title %}Udostępnianie w mediach społecznościowych - {{ super() }}{% endblock %}

{% block page_title %}<i class="fas fa-share-alt me-2"></i>Udostępnianie w mediach społecznościowych{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/social-sharing.css') }}">
<style>
.sharing-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.sharing-preview img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
}

.post-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    transition: all 0.3s ease;
}

.post-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.post-thumbnail {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
}

.auto-posting-section {
    background: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.auto-posting-section h6 {
    color: #1976d2;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5><i class="fas fa-bullhorn me-2"></i>Automatyczne publikowanie</h5>
                </div>
                <div class="admin-card-body">
                    <div class="auto-posting-section">
                        <h6><i class="fas fa-info-circle me-2"></i>Informacja</h6>
                        <p class="mb-0">
                            Automatyczne publikowanie na mediach społecznościowych wymaga konfiguracji API dla każdej platformy. 
                            Obecnie dostępne jest ręczne udostępnianie poprzez gotowe linki.
                        </p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Wybierz post do udostępnienia:</label>
                                <select class="form-select" id="postSelect">
                                    <option value="">-- Wybierz post --</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Platformy:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="platformFacebook" value="facebook">
                                    <label class="form-check-label" for="platformFacebook">
                                        <i class="fab fa-facebook-f me-1" style="color: #1877f2;"></i>Facebook
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="platformTwitter" value="twitter">
                                    <label class="form-check-label" for="platformTwitter">
                                        <i class="fab fa-twitter me-1" style="color: #1da1f2;"></i>Twitter
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="platformLinkedIn" value="linkedin">
                                    <label class="form-check-label" for="platformLinkedIn">
                                        <i class="fab fa-linkedin-in me-1" style="color: #0077b5;"></i>LinkedIn
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-end">
                        <button class="btn btn-primary" onclick="generateSharingLinks()">
                            <i class="fas fa-link me-2"></i>Generuj linki udostępniania
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row" id="sharingResults" style="display: none;">
        <div class="col-12">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5><i class="fas fa-share-nodes me-2"></i>Linki udostępniania</h5>
                </div>
                <div class="admin-card-body">
                    <div id="sharingLinksContainer"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5><i class="fas fa-newspaper me-2"></i>Ostatnie posty</h5>
                </div>
                <div class="admin-card-body">
                    <div id="recentPosts">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="text-muted mt-2">Ładowanie postów...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/utils/social-sharing.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadRecentPosts();
});

function loadRecentPosts() {
    fetch('/api/blog/admin/posts?per_page=10', {
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayRecentPosts(data.posts);
            populatePostSelect(data.posts);
        } else {
            document.getElementById('recentPosts').innerHTML = 
                '<div class="alert alert-danger">Błąd podczas ładowania postów</div>';
        }
    })
    .catch(error => {
        console.error('Error loading posts:', error);
        document.getElementById('recentPosts').innerHTML = 
            '<div class="alert alert-danger">Błąd podczas ładowania postów</div>';
    });
}

function displayRecentPosts(posts) {
    const container = document.getElementById('recentPosts');
    
    if (posts.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">Brak postów</div>';
        return;
    }
    
    let html = '';
    posts.forEach(post => {
        const publishedDate = post.published_at ? new Date(post.published_at).toLocaleDateString('pl-PL') : 'Nie opublikowany';
        const statusClass = post.status === 'published' ? 'text-success' : 'text-warning';
        const statusText = post.status === 'published' ? 'Opublikowany' : 'Szkic';
        
        html += `
            <div class="post-card">
                <div class="row align-items-center">
                    <div class="col-md-2">
                        ${post.featured_image ? 
                            `<img src="${post.featured_image}" class="post-thumbnail" alt="${post.title}">` :
                            '<div class="post-thumbnail bg-light d-flex align-items-center justify-content-center"><i class="fas fa-image text-muted"></i></div>'
                        }
                    </div>
                    <div class="col-md-6">
                        <h6 class="mb-1">${post.title}</h6>
                        <p class="text-muted small mb-1">${post.excerpt || post.content.substring(0, 100) + '...'}</p>
                        <small class="${statusClass}">${statusText} - ${publishedDate}</small>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="initSharingForPost(${post.id})">
                                <i class="fas fa-share-alt me-1"></i>Udostępnij
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyPostLink(${post.id})">
                                <i class="fas fa-copy me-1"></i>Kopiuj link
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function populatePostSelect(posts) {
    const select = document.getElementById('postSelect');
    posts.forEach(post => {
        const option = document.createElement('option');
        option.value = post.id;
        option.textContent = `${post.title} (${post.status === 'published' ? 'Opublikowany' : 'Szkic'})`;
        select.appendChild(option);
    });
}

function generateSharingLinks() {
    const postId = document.getElementById('postSelect').value;
    const platforms = [];
    
    if (document.getElementById('platformFacebook').checked) platforms.push('facebook');
    if (document.getElementById('platformTwitter').checked) platforms.push('twitter');
    if (document.getElementById('platformLinkedIn').checked) platforms.push('linkedin');
    
    if (!postId) {
        alert('Wybierz post do udostępnienia');
        return;
    }
    
    if (platforms.length === 0) {
        alert('Wybierz przynajmniej jedną platformę');
        return;
    }
    
    // Initialize social sharing
    window.socialSharing.init(postId).then(success => {
        if (success) {
            const sharingData = window.socialSharing.getSharingData();
            const sharingLinks = window.socialSharing.getSharingLinks();
            
            displaySharingResults(sharingData, sharingLinks, platforms);
        } else {
            alert('Błąd podczas generowania linków udostępniania');
        }
    });
}

function displaySharingResults(sharingData, sharingLinks, platforms) {
    const container = document.getElementById('sharingLinksContainer');
    const resultsSection = document.getElementById('sharingResults');
    
    let html = `
        <div class="sharing-preview">
            <h6>Podgląd udostępniania:</h6>
            <div class="row">
                <div class="col-md-3">
                    ${sharingData.thumbnail_url ? 
                        `<img src="${sharingData.thumbnail_url}" alt="${sharingData.title}" class="img-fluid">` :
                        '<div class="bg-light p-3 text-center"><i class="fas fa-image fa-2x text-muted"></i></div>'
                    }
                </div>
                <div class="col-md-9">
                    <h6>${sharingData.title}</h6>
                    <p class="text-muted">${sharingData.excerpt}</p>
                    <small class="text-muted">Autor: ${sharingData.author}</small>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <h6>Linki udostępniania:</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Platforma</th>
                            <th>Link</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    platforms.forEach(platform => {
        const link = sharingLinks[platform];
        if (link) {
            html += `
                <tr>
                    <td>
                        <i class="${link.icon} me-2" style="color: ${link.color};"></i>
                        ${link.name}
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" value="${link.url}" readonly>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('${link.url}')">
                            <i class="fas fa-copy me-1"></i>Kopiuj
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="openSharingLink('${link.url}', '${platform}')">
                            <i class="fas fa-external-link-alt me-1"></i>Otwórz
                        </button>
                    </td>
                </tr>
            `;
        }
    });
    
    html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    resultsSection.style.display = 'block';
}

function initSharingForPost(postId) {
    window.socialSharing.init(postId).then(success => {
        if (success) {
            const sharingLinks = window.socialSharing.getSharingLinks();
            // Show sharing options for this specific post
            showPostSharingModal(postId, sharingLinks);
        } else {
            alert('Błąd podczas inicjalizacji udostępniania');
        }
    });
}

function showPostSharingModal(postId, sharingLinks) {
    // Create a simple modal for quick sharing
    const modalHtml = `
        <div class="modal fade" id="postSharingModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Udostępnij post</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="postSharingButtons"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('postSharingModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Initialize sharing buttons
    window.socialSharing.createSharingButtons('postSharingButtons');
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('postSharingModal'));
    modal.show();
    
    // Clean up modal when closed
    document.getElementById('postSharingModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show success message
        if (window.toastManager) {
            window.toastManager.show('Link został skopiowany do schowka', 'success');
        } else {
            alert('Link został skopiowany do schowka');
        }
    }).catch(err => {
        console.error('Error copying to clipboard:', err);
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        if (window.toastManager) {
            window.toastManager.show('Link został skopiowany do schowka', 'success');
        } else {
            alert('Link został skopiowany do schowka');
        }
    });
}

function openSharingLink(url, platform) {
    const width = platform === 'facebook' ? 626 : 550;
    const height = platform === 'facebook' ? 436 : 420;
    
    const left = (screen.width - width) / 2;
    const top = (screen.height - height) / 2;

    window.open(
        url,
        `${platform}_share`,
        `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
    );
}
</script>
{% endblock %}





