{% extends "admin/base.html" %}

{% block title %}Użytkownicy{% endblock %}

{% block page_title %}
    <i class="fas fa-users me-2"></i>Zarządzanie Użytkownikami
{% endblock %}

{% block page_actions %}
    <div class="d-flex justify-content-end gap-2 mb-3">
        <button class="btn admin-btn-danger" id="bulkDeleteBtn" style="display: none;">
            <i class="fas fa-trash me-2"></i>
            Usuń Zaznaczone
        </button>

    </div>
{% endblock %}

{% block content %}
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-users"></i>
                <h3>{{ stats.total_users }}</h3>
                <p>Wszyscy Użytkownicy</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-user-check"></i>
                <h3>{{ stats.active_users }}</h3>
                <p>Aktywne Konta</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-user-shield"></i>
                <h3>{{ stats.admin_users }}</h3>
                <p>Administratorzy</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-user-clock"></i>
                <h3>{{ stats.never_logged_users }}</h3>
                <p>Nigdy Nie Logowali</p>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="admin-card mb-4">
        <div class="admin-card-header">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Filtry
                {% if active_filters_count > 0 %}
                <span class="badge bg-primary ms-2">{{ active_filters_count }} aktywny</span>
                {% endif %}
                <button class="btn btn-sm admin-btn-outline ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse">
                    <i class="fas fa-chevron-down" id="filtersIcon"></i>
                </button>
            </h5>
        </div>
        <div class="collapse" id="filtersCollapse">
            <div class="admin-card-body">
                <form id="filtersForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filterName" class="form-label">Imię</label>
                            <input type="text" class="form-control" id="filterName" placeholder="Wpisz imię...">
                        </div>
                        <div class="col-md-3">
                            <label for="filterEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="filterEmail" placeholder="Wpisz email...">
                        </div>
                        <div class="col-md-3">
                            <label for="filterRole" class="form-label">Rola</label>
                            <select class="form-select" id="filterRole">
                                <option value="">Wszystkie role</option>
                                <option value="admin">Administrator</option>
                                <option value="ankieter">Ankieter</option>
                                <option value="user">Użytkownik</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterStatus" class="form-label">Status</label>
                            <select class="form-select" id="filterStatus">
                                <option value="">Wszystkie statusy</option>
                                <option value="active">Aktywny</option>
                                <option value="inactive">Nieaktywny</option>
                                <option value="never_logged">Nigdy nie logował</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label for="filterClubMember" class="form-label">Członek klubu</label>
                            <select class="form-select" id="filterClubMember">
                                <option value="">Wszyscy</option>
                                <option value="true">Tak</option>
                                <option value="false">Nie</option>
                            </select>
                        </div>
                        <div class="col-md-9 d-flex align-items-end">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn admin-btn" id="applyFilters">
                                    <i class="fas fa-search me-2"></i>Filtruj
                                </button>
                                <button type="button" class="btn admin-btn-outline" id="clearFilters">
                                    <i class="fas fa-times me-2"></i>Wyczyść
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Users Table -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h5 class="mb-0">
                <i class="fas fa-users me-2"></i>Lista użytkowników
                {% if active_filters_count > 0 %}
                <span class="text-muted ms-2">({{ users|length }} z {{ pagination.total }})</span>
                {% else %}
                <span class="text-muted ms-2">({{ pagination.total }})</span>
                {% endif %}
            </h5>
        </div>
        <div class="admin-card-body">
            {% if edit_user %}
            <!-- Edit User Form -->
            <div class="admin-card mb-4">
                <div class="admin-card-header">
                    <h5><i class="fas fa-user-edit me-2"></i>Edytuj użytkownika: {{ edit_user.first_name }}</h5>
                </div>
                <div class="admin-card-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId" value="{{ edit_user.id }}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="editUserName" class="form-label">Imię</label>
                                <input type="text" class="form-control" id="editUserName" value="{{ edit_user.first_name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editUserEmail" value="{{ edit_user.email }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserPhone" class="form-label">Telefon</label>
                                <input type="tel" class="form-control" id="editUserPhone" value="{{ edit_user.phone or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="editUserClub" class="form-label">Członek klubu</label>
                                <select class="form-select" id="editUserClub">
                                    <option value="true" {% if edit_user.club_member %}selected{% endif %}>Tak</option>
                                    <option value="false" {% if not edit_user.club_member %}selected{% endif %}>Nie</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserActive" class="form-label">Status</label>
                                <select class="form-select" id="editUserActive">
                                    <option value="true" {% if edit_user.is_active %}selected{% endif %}>Aktywny</option>
                                    <option value="false" {% if not edit_user.is_active %}selected{% endif %}>Nieaktywny</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserRole" class="form-label">Rola</label>
                                <select class="form-select" id="editUserRole">
                                    <option value="user" {% if edit_user.role == 'user' %}selected{% endif %}>Użytkownik</option>
                                    <option value="ankieter" {% if edit_user.role == 'ankieter' %}selected{% endif %}>Ankieter</option>
                                    <option value="admin" {% if edit_user.role == 'admin' or edit_user.is_admin %}selected{% endif %}>Administrator</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="editUserPassword" class="form-label">Nowe hasło</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="editUserPassword" placeholder="Zostaw puste, aby nie zmieniać hasła">
                                    <button class="btn btn-outline-secondary" type="button" onclick="generatePassword()">
                                        <i class="fas fa-random"></i> Generuj
                                    </button>
                                </div>
                                <div class="form-text">Zostaw puste, aby nie zmieniać hasła. Jeśli ustawisz nowe hasło, zostanie wysłany email do użytkownika.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserPasswordConfirm" class="form-label">Potwierdź hasło</label>
                                <input type="password" class="form-control" id="editUserPasswordConfirm" placeholder="Potwierdź nowe hasło">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn admin-btn">
                                <i class="fas fa-save me-2"></i>Zapisz zmiany
                            </button>
                            <a href="{{ url_for('users.index') }}" class="btn admin-btn-secondary ms-2">
                                <i class="fas fa-times me-2"></i>Anuluj
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
            
            {% if users %}
                <div class="table-responsive">
                    <table id="usersTable" class="table admin-table bulk-delete-table" data-delete-endpoint="/api/bulk-delete/users">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" class="form-check-input">
                                </th>
                                <th>ID</th>
                                <th>Imię</th>
                                <th>Email</th>
                                <th>Telefon</th>
                                <th>Członek klubu</th>
                                <th>Status</th>
                                <th>Ostatnie logowanie</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr data-user-id="{{ user.id }}">
                                <td>
                                    {% if not user.is_admin %}
                                    <input type="checkbox" name="itemIds" value="{{ user.id }}">
                                    {% endif %}
                                </td>
                                <td>{{ user.id }}</td>
                                <td>
                                    <strong>{{ user.first_name }}</strong>
                                    <br><small class="text-muted">
                                        {% if user.role == 'admin' or user.is_admin %}
                                            Administrator
                                        {% elif user.role == 'ankieter' %}
                                            Ankieter
                                        {% else %}
                                            Użytkownik
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <a href="mailto:{{ user.email }}" class="text-decoration-none">
                                        {{ user.email }}
                                    </a>
                                </td>
                                <td>{{ user.phone or 'Brak' }}</td>
                                <td>
                                    {% if user.club_member %}
                                        <span class="badge admin-badge admin-badge-success">Tak</span>
                                    {% else %}
                                        <span class="badge admin-badge admin-badge-secondary">Nie</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.is_active %}
                                        <span class="badge admin-badge admin-badge-success">Aktywny</span>
                                    {% else %}
                                        <span class="badge admin-badge admin-badge-danger">Nieaktywny</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.last_login %}
                                        {{ user.last_login.strftime('%d.%m.%Y %H:%M') }}
                                    {% else %}
                                        <span class="text-muted">Nigdy</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm admin-btn-outline" 
                                                onclick="editUser({{ user.id }})" 
                                                title="Edytuj użytkownika">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% if not user.is_admin %}
                                        <button type="button" class="btn btn-sm admin-btn-danger" 
                                                onclick="deleteUser({{ user.id }})" 
                                                title="Usuń użytkownika">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                
                <!-- Pagination -->
                <div id="pagination" class="mt-4 pagination-container" 
                     data-show-info="true" 
                     data-show-per-page="true" 
                     data-default-per-page="10" 
                     data-max-visible-pages="5"></div>
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Brak użytkowników w systemie</p>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Set up pagination handlers for auto-initialization
        {% if pagination %}
        window.flaskPaginationData = {
            page: {{ pagination.page }},
            pages: {{ pagination.pages }},
            total: {{ pagination.total }},
            per_page: {{ pagination.per_page }}
        };
        
        window.paginationHandlers = {
            onPageChange: (page) => {
                const perPage = {{ pagination.per_page if pagination else 10 }};
                window.location.href = `{{ url_for('users.index') }}?page=${page}&per_page=${perPage}`;
            },
            onPerPageChange: (newPage, perPage) => {
                window.location.href = `{{ url_for('users.index') }}?page=${newPage}&per_page=${perPage}`;
            }
        };
        {% endif %}
    });
    
    
</script>

<!-- External JavaScript -->
<script src="{{ url_for('static', filename='js/admin/users.js') }}"></script>
{% endblock %}
