{% extends "admin/base.html" %}

{% block title %}Użytkownicy{% endblock %}

{% block page_title %}
    <i class="fas fa-users me-2"></i>Zarządzanie Użytkownikami
{% endblock %}

{% block page_actions %}
    <div class="d-flex justify-content-end gap-2 mb-3">
        <button class="btn btn-warning" id="bulkEditBtn" style="display: none; background-color: #d97706 !important; border-color: #d97706 !important; color: white !important;">
            <i class="fas fa-edit me-2"></i>
            Edytuj Zaznaczone
        </button>
        <button class="btn admin-btn-danger" id="bulkDeleteBtn" style="display: none;">
            <i class="fas fa-trash me-2"></i>
            Usuń Zaznaczone
        </button>
    </div>
{% endblock %}

{% block content %}
    <!-- Stats Cards -->
    <div class="row mb-4"></div>
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-users"></i>
                <h3 id="totalUsers">{{ stats.total_users }}</h3>
                <p>Wszyscy Użytkownicy</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-user-check"></i>
                <h3 id="activeUsers">{{ stats.active_users }}</h3>
                <p>Aktywne Konta</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-user-shield"></i>
                <h3 id="adminUsers">{{ stats.admin_users }}</h3>
                <p>Administratorzy</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-calendar-check"></i>
                <h3 id="eventRegistrations">{{ stats.event_registrations }}</h3>
                <p>Z Rejestracji na Wydarzenia</p>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="admin-card mb-4">
        <div class="admin-card-header">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Filtry
                {% if active_filters_count > 0 %}
                <span class="badge bg-primary ms-2">{{ active_filters_count }} aktywny</span>
                {% endif %}
                <button class="btn btn-sm admin-btn-outline ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse">
                    <i class="fas fa-chevron-down" id="filtersIcon"></i>
                </button>
            </h5>
        </div>
        <div class="collapse" id="filtersCollapse">
            <div class="admin-card-body">
                <form id="filtersForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filterName" class="form-label">Imię</label>
                            <input type="text" class="form-control" id="filterName" placeholder="Wpisz imię...">
                        </div>
                        <div class="col-md-3">
                            <label for="filterEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="filterEmail" placeholder="Wpisz email...">
                        </div>
                        <div class="col-md-3">
                            <label for="filterAccountType" class="form-label">Typ Konta</label>
                            <select class="form-select" id="filterAccountType">
                                <option value="">Wszystkie typy</option>
                                <option value="admin">Administrator</option>
                                <option value="user">Użytkownik</option>
                                <option value="ankieter">Ankieter</option>
                                <option value="event_registration">Rejestracja na wydarzenia</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterStatus" class="form-label">Status</label>
                            <select class="form-select" id="filterStatus">
                                <option value="">Wszystkie statusy</option>
                                <option value="active">Aktywny</option>
                                <option value="inactive">Nieaktywny</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label for="filterClubMember" class="form-label">Członek klubu</label>
                            <select class="form-select" id="filterClubMember">
                                <option value="">Wszyscy</option>
                                <option value="true">Tak</option>
                                <option value="false">Nie</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterEvent" class="form-label">Wydarzenie</label>
                            <select class="form-select" id="filterEvent">
                                <option value="">Wszystkie wydarzenia</option>
                                {% for event in events %}
                                <option value="{{ event.id }}">{{ event.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterGroup" class="form-label">Grupa</label>
                            <select class="form-select" id="filterGroup">
                                <option value="">Wszystkie grupy</option>
                                {% for group in groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-9 d-flex align-items-end">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn admin-btn" id="applyFilters">
                                    <i class="fas fa-search me-2"></i>Filtruj
                                </button>
                                <button type="button" class="btn admin-btn-outline" id="clearFilters">
                                    <i class="fas fa-times me-2"></i>Wyczyść
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Users Table -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h5 class="mb-0">
                <i class="fas fa-users me-2"></i>Lista użytkowników
                {% if active_filters_count > 0 %}
                <span class="text-muted ms-2">({{ users|length }} z {{ pagination.total }})</span>
                {% else %}
                <span class="text-muted ms-2">({{ pagination.total }})</span>
                {% endif %}
            </h5>
        </div>
        <div class="admin-card-body">
            {% if edit_user %}
            <!-- Edit User Form -->
            <div class="admin-card mb-4">
                <div class="admin-card-header">
                    <h5><i class="fas fa-user-edit me-2"></i>Edytuj użytkownika: {{ edit_user.first_name }}</h5>
                </div>
                <div class="admin-card-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId" value="{{ edit_user.id }}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="editUserName" class="form-label">Imię</label>
                                <input type="text" class="form-control" id="editUserName" value="{{ edit_user.first_name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editUserEmail" value="{{ edit_user.email }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserPhone" class="form-label">Telefon</label>
                                <input type="tel" class="form-control" id="editUserPhone" value="{{ edit_user.phone or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="editUserClub" class="form-label">Członek klubu</label>
                                <select class="form-select" id="editUserClub">
                                    <option value="true" {% if edit_user.club_member %}selected{% endif %}>Tak</option>
                                    <option value="false" {% if not edit_user.club_member %}selected{% endif %}>Nie</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserActive" class="form-label">Status</label>
                                <select class="form-select" id="editUserActive">
                                    <option value="true" {% if edit_user.is_active %}selected{% endif %}>Aktywny</option>
                                    <option value="false" {% if not edit_user.is_active %}selected{% endif %}>Nieaktywny</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserAccountType" class="form-label">Typ Konta</label>
                                <select class="form-select" id="editUserAccountType">
                                    <option value="user" {% if edit_user.account_type == 'user' %}selected{% endif %}>Użytkownik</option>
                                    <option value="admin" {% if edit_user.account_type == 'admin' %}selected{% endif %}>Administrator</option>
                                    <option value="ankieter" {% if edit_user.account_type == 'ankieter' %}selected{% endif %}>Ankieter</option>
                                    <option value="event_registration" {% if edit_user.account_type == 'event_registration' %}selected{% endif %}>Rejestracja na wydarzenia</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="editUserPassword" class="form-label">Nowe hasło</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="editUserPassword" placeholder="Zostaw puste, aby nie zmieniać hasła">
                                    <button class="btn btn-outline-secondary" type="button" onclick="generatePassword()">
                                        <i class="fas fa-random"></i> Generuj
                                    </button>
                                </div>
                                <div class="form-text">Zostaw puste, aby nie zmieniać hasła. Jeśli ustawisz nowe hasło, zostanie wysłany email do użytkownika.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserPasswordConfirm" class="form-label">Potwierdź hasło</label>
                                <input type="password" class="form-control" id="editUserPasswordConfirm" placeholder="Potwierdź nowe hasło">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn admin-btn">
                                <i class="fas fa-save me-2"></i>Zapisz zmiany
                            </button>
                            <a href="{{ url_for('users.index') }}" class="btn admin-btn-secondary ms-2">
                                <i class="fas fa-times me-2"></i>Anuluj
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
            
            {% if users %}
                <div class="table-responsive">
                    <table id="usersTable" class="table admin-table bulk-delete-table resizable-table" data-delete-endpoint="/api/bulk-delete/users">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" class="form-check-input">
                                </th>
                                <th>ID</th>
                                <th>Imię</th>
                                <th>Email</th>
                                <th>Wydarzenie</th>
                                <th>ID grupy</th>
                                <th>Typ Konta</th>
                                <th>Status</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr data-user-id="{{ user.id }}">
                                <td>
                                    {% if not user.is_admin %}
                                    <input type="checkbox" name="itemIds" value="{{ user.id }}">
                                    {% endif %}
                                </td>
                                <td><span class="badge admin-badge admin-badge-primary">{{ user.id }}</span></td>
                                <td>
                                    <strong>{{ user.first_name }}</strong>
                                </td>
                                <td>
                                    <a href="mailto:{{ user.email }}" class="text-decoration-none">
                                        {{ user.email }}
                                    </a>
                                </td>
                                <td>
                                    {% set user_events = [] %}
                                    {% for reg in user.event_registrations %}
                                        {% if reg.is_active %}
                                            {% set _ = user_events.append(reg.event_id) %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if user_events %}
                                        {% for event_id in user_events %}
                                            <span class="badge admin-badge admin-badge-info me-1">{{ event_id }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set user_groups = [] %}
                                    {% for membership in user.group_memberships %}
                                        {% if membership.is_active and membership.group_id not in user_groups %}
                                            {% set _ = user_groups.append(membership.group_id) %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if user_groups %}
                                        {% for group_id in user_groups %}
                                            <a href="#" 
                                               onclick="editGroup({{ group_id }})"
                                               class="badge admin-badge admin-badge-primary me-1" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Grupa ID: {{ group_id }}">
                                                {{ group_id }}
                                            </a>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.account_type == 'admin' %}
                                        <span class="badge admin-badge admin-badge-danger">Administrator</span>
                                    {% elif user.account_type == 'ankieter' %}
                                        <span class="badge admin-badge admin-badge-warning">Ankieter</span>
                                    {% elif user.account_type == 'event_registration' %}
                                        <span class="badge admin-badge admin-badge-info">Rejestracja na wydarzenia</span>
                                    {% else %}
                                        <span class="badge admin-badge admin-badge-secondary">Użytkownik</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.is_active %}
                                        <span class="badge admin-badge admin-badge-success">Aktywny</span>
                                    {% else %}
                                        <span class="badge admin-badge admin-badge-danger">Nieaktywny</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm admin-btn-outline" 
                                                onclick="viewUserProfile({{ user.id }})" 
                                                title="Podgląd profilu">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm admin-btn-outline" 
                                                onclick="editUser({{ user.id }})" 
                                                title="Edytuj użytkownika">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% if not user.is_admin %}
                                        <button type="button" class="btn btn-sm admin-btn-danger" 
                                                onclick="deleteUser({{ user.id }})" 
                                                title="Usuń użytkownika">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                
                <!-- Pagination -->
                <div id="pagination" class="mt-4 pagination-container" 
                     data-show-info="true" 
                     data-show-per-page="true" 
                     data-default-per-page="10" 
                     data-max-visible-pages="5"></div>
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Brak użytkowników w systemie</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userProfileModalLabel">
                        <i class="fas fa-user me-2"></i>Podgląd profilu użytkownika
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="userProfileContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Ładowanie...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/utils/tooltip.js') }}"></script>
<script>
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Set up pagination handlers for auto-initialization
        {% if pagination %}
        // Initialize SimplePagination for users
        if (typeof SimplePagination !== 'undefined') {
            const paginationContainer = document.getElementById('pagination');
            if (paginationContainer) {
                const paginationData = {
                    page: {{ pagination.page }},
                    pages: {{ pagination.pages }},
                    total: {{ pagination.total }},
                    per_page: {{ pagination.per_page }}
                };
                
                const paginationInstance = new SimplePagination('pagination', {
                    showInfo: true,
                    showPerPage: true,
                    perPageOptions: [5, 10, 25, 50, 100],
                    defaultPerPage: {{ pagination.per_page if pagination else 10 }},
                    maxVisiblePages: 5
                });
                
                paginationInstance.setPageChangeCallback((page) => {
                    const perPage = paginationInstance.getPerPage();
                    const currentParams = new URLSearchParams(window.location.search);
                    currentParams.set('page', page);
                    currentParams.set('per_page', perPage);
                    window.location.href = `{{ url_for('users.index') }}?${currentParams.toString()}`;
                });
                
                paginationInstance.setPerPageChangeCallback((newPage, perPage) => {
                    const currentParams = new URLSearchParams(window.location.search);
                    currentParams.set('page', newPage);
                    currentParams.set('per_page', perPage);
                    window.location.href = `{{ url_for('users.index') }}?${currentParams.toString()}`;
                });
                
                paginationInstance.setData(paginationData);
            }
        }
        {% endif %}
        
        // Initialize CRUD Refresh Manager for users
        if (typeof CRUDRefreshManager !== 'undefined' && window.crudRefreshManager) {
            window.crudRefreshManager.init(() => {
                // Refresh function for users - reload stats and page
                loadUserStats();
                window.location.reload();
            });
            console.log('CRUD Refresh Manager initialized for users');
        }
        
        // Load user stats on page load
        loadUserStats();
        
        // Setup auto-refresh for user stats
        setupUserStatsAutoRefresh();
        
        // Setup filters state management
        setupFiltersState();
    });
    
    // Load user statistics
    function loadUserStats() {
        // Show loading indicator
        const statsCards = document.querySelectorAll('.admin-stats-card h3');
        statsCards.forEach(card => {
            card.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        });
        
        fetch('/api/stats/users')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('totalUsers').textContent = data.stats.total || 0;
                    document.getElementById('activeUsers').textContent = data.stats.active || 0;
                    document.getElementById('adminUsers').textContent = data.stats.admin || 0;
                    document.getElementById('eventRegistrations').textContent = data.stats.total_registrations || 0;
                    console.log('User stats updated:', data.stats);
                } else {
                    console.error('Error loading user stats:', data.message);
                    // Restore original values on error
                    statsCards.forEach(card => {
                        card.textContent = '0';
                    });
                }
            })
            .catch(error => {
                console.error('Error loading user stats:', error);
                // Restore original values on error
                statsCards.forEach(card => {
                    card.textContent = '0';
                });
            });
    }
    
    // Setup auto-refresh for user stats
    let userStatsRefreshInterval;
    
    function setupUserStatsAutoRefresh() {
        // Refresh every 60 seconds (less frequent since user stats don't change often)
        userStatsRefreshInterval = setInterval(() => {
            loadUserStats();
        }, 60000); // 60 seconds
        
        console.log('User stats auto-refresh setup: every 60 seconds');
    }
    
    // Setup filters state management
    function setupFiltersState() {
        const filtersCollapse = document.getElementById('filtersCollapse');
        const filtersButton = document.querySelector('[data-bs-target="#filtersCollapse"]');
        const filtersIcon = document.getElementById('filtersIcon');
        
        if (!filtersCollapse || !filtersButton || !filtersIcon) return;
        
        // Check if filters should be expanded based on URL parameters or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const hasFilters = urlParams.has('filterName') || urlParams.has('filterEmail') || 
                          urlParams.has('filterGroup') || urlParams.has('filterStatus') ||
                          urlParams.has('filterRole');
        
        // Restore state from localStorage if no URL filters
        const savedState = localStorage.getItem('usersFiltersExpanded');
        const shouldExpand = hasFilters || savedState === 'true';
        
        if (shouldExpand) {
            filtersCollapse.classList.add('show');
            filtersButton.setAttribute('aria-expanded', 'true');
            filtersIcon.classList.remove('fa-chevron-down');
            filtersIcon.classList.add('fa-chevron-up');
        }
        
        // Save state when filters are toggled
        filtersCollapse.addEventListener('shown.bs.collapse', function() {
            filtersButton.setAttribute('aria-expanded', 'true');
            filtersIcon.classList.remove('fa-chevron-down');
            filtersIcon.classList.add('fa-chevron-up');
            localStorage.setItem('usersFiltersExpanded', 'true');
        });
        
        filtersCollapse.addEventListener('hidden.bs.collapse', function() {
            filtersButton.setAttribute('aria-expanded', 'false');
            filtersIcon.classList.remove('fa-chevron-up');
            filtersIcon.classList.add('fa-chevron-down');
            localStorage.setItem('usersFiltersExpanded', 'false');
        });
    }
    
    // View user profile function
    function viewUserProfile(userId) {
        const modal = new bootstrap.Modal(document.getElementById('userProfileModal'));
        const content = document.getElementById('userProfileContent');
        
        // Show loading
        content.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Ładowanie...</span>
                </div>
            </div>
        `;
        
        modal.show();
        
        // Fetch user profile data
        fetch(`/api/users/profile/${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const user = data.user;
                    const eventHistory = data.event_history || [];
                    
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">Podstawowe dane</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Imię:</strong></td>
                                        <td>${user.first_name}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Email:</strong></td>
                                        <td><a href="mailto:${user.email}">${user.email}</a></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Członek klubu:</strong></td>
                                        <td>
                                            <span class="badge ${user.club_member ? 'bg-success' : 'bg-secondary'}">
                                                ${user.club_member ? 'Tak' : 'Nie'}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Ostatnie logowanie:</strong></td>
                                        <td>${user.last_login ? formatDate(user.last_login) : 'Nigdy'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Data utworzenia konta:</strong></td>
                                        <td>${formatDate(user.created_at)}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">Historia wydarzeń</h6>
                                ${eventHistory.length > 0 ? `
                                    <div class="list-group">
                                        ${eventHistory.map(event => `
                                            <div class="list-group-item">
                                                <div class="d-flex w-100 justify-content-between">
                                                    <h6 class="mb-1">${event.event_title}</h6>
                                                    <small>${new Date(event.registration_date).toLocaleDateString('pl-PL')}</small>
                                                </div>
                                                <p class="mb-1">Data wydarzenia: ${event.event_date ? new Date(event.event_date).toLocaleDateString('pl-PL') : 'Nie określono'}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <p class="text-muted">Brak historii wydarzeń</p>
                                `}
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Błąd ładowania profilu: ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Błąd ładowania profilu: ${error.message}
                    </div>
                `;
            });
    }
    
    // Date formatting function
    function formatDate(dateString) {
        if (!dateString) return 'Brak';
        const date = new Date(dateString);
        const formatted = date.toLocaleDateString('pl-PL', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        return formatted;
    }
    
    
</script>

<style>
/* Hover effect for group IDs */
.badge.admin-badge-primary:hover {
    color: white !important;
    background-color: #1e3a8a !important;
}
</style>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">
                    <i class="fas fa-user-edit me-2"></i>Edytuj użytkownika
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editUserModalForm">
                <input type="hidden" id="editUserId" name="id">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="editUserName" class="form-label">Imię *</label>
                            <input type="text" class="form-control" id="editUserName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editUserEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="editUserEmail" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editUserPhone" class="form-label">Telefon</label>
                            <input type="tel" class="form-control" id="editUserPhone">
                        </div>
                        <div class="col-md-6">
                            <label for="editUserClub" class="form-label">Członek klubu</label>
                            <select class="form-select" id="editUserClub">
                                <option value="false">Nie</option>
                                <option value="true">Tak</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editUserAccountType" class="form-label">Typ konta</label>
                            <select class="form-select" id="editUserAccountType">
                                <option value="user">Użytkownik</option>
                                <option value="admin">Administrator</option>
                                <option value="ankieter">Ankieter</option>
                                <option value="event_registration">Rejestracja na wydarzenia</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editUserActive" class="form-label">Status konta</label>
                            <select class="form-select" id="editUserActive">
                                <option value="true">Aktywny</option>
                                <option value="false">Nieaktywny</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editUserPassword" class="form-label">Nowe hasło</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="editUserPassword" placeholder="Zostaw puste, aby nie zmieniać">
                                <button class="btn btn-outline-secondary" type="button" onclick="generatePassword()">
                                    <i class="fas fa-random"></i> Generuj
                                </button>
                            </div>
                            <small class="form-text text-muted">Zostaw puste, aby nie zmieniać hasła</small>
                        </div>
                        <div class="col-md-6">
                            <label for="editUserPasswordConfirm" class="form-label">Potwierdź hasło</label>
                            <input type="password" class="form-control" id="editUserPasswordConfirm" placeholder="Potwierdź nowe hasło">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn admin-btn">
                        <i class="fas fa-save me-2"></i>Zapisz zmiany
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Edit Modal -->
<div class="modal fade" id="bulkEditModal" tabindex="-1" aria-labelledby="bulkEditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkEditModalLabel">
                    <i class="fas fa-edit me-2"></i>Edycja masowa użytkowników
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Zaznaczono <strong id="selectedCount">0</strong> użytkowników do edycji.
                </div>
                
                <form id="bulkEditForm">
                    <div class="mb-3">
                        <label class="form-label">Członkostwo w klubie</label>
                        <select class="form-select" id="bulkClubMember" name="club_member">
                            <option value="">Nie zmieniaj</option>
                            <option value="true">Ustaw jako członka klubu</option>
                            <option value="false">Usuń z klubu</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Status konta</label>
                        <select class="form-select" id="bulkStatus" name="is_active">
                            <option value="">Nie zmieniaj</option>
                            <option value="true">Aktywuj konto</option>
                            <option value="false">Dezaktywuj konto</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Typ konta</label>
                        <select class="form-select" id="bulkAccountType" name="account_type">
                            <option value="">Nie zmieniaj</option>
                            <option value="user">Użytkownik</option>
                            <option value="admin">Administrator</option>
                            <option value="ankieter">Ankieter</option>
                            <option value="event_registration">Rejestracja na wydarzenia</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" id="confirmBulkEdit">
                    <i class="fas fa-save me-2"></i>Zapisz zmiany
                </button>
            </div>
        </div>
    </div>
</div>

<!-- External JavaScript -->
<script src="{{ url_for('static', filename='js/admin/users.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin/email_groups.js') }}"></script>
{% endblock %}
