{% extends "admin/base.html" %}

{% block title %}Użytkownicy{% endblock %}

{% block page_title %}
    <i class="fas fa-users me-2"></i>Zarządzanie Użytkownikami
{% endblock %}

{% block page_actions %}
    <div class="d-flex justify-content-end gap-2 mb-3">
        <a href="{{ url_for('auth.logout') }}" class="btn admin-btn-logout">
            <i class="fas fa-sign-out-alt me-2"></i>
            Wyloguj
        </a>
    </div>
{% endblock %}

{% block content %}
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-users"></i>
                <h3>{{ users|length }}</h3>
                <p>Wszyscy Użytkownicy</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-user-check"></i>
                <h3>{{ users|selectattr('is_active', 'equalto', true)|list|length }}</h3>
                <p>Aktywne Konta</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-user-shield"></i>
                <h3>{{ users|selectattr('is_admin', 'equalto', true)|list|length }}</h3>
                <p>Administratorzy</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-user-clock"></i>
                <h3>{{ users|selectattr('last_login', 'none')|list|length }}</h3>
                <p>Nigdy Nie Logowali</p>
            </div>
        </div>
    </div>
    
    <!-- Users Table -->
    <div class="admin-card">
        <div class="admin-card-body">
            {% if edit_user %}
            <!-- Edit User Form -->
            <div class="admin-card mb-4">
                <div class="admin-card-header">
                    <h5><i class="fas fa-user-edit me-2"></i>Edytuj użytkownika: {{ edit_user.name }}</h5>
                </div>
                <div class="admin-card-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId" value="{{ edit_user.id }}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="editUserName" class="form-label">Imię</label>
                                <input type="text" class="form-control" id="editUserName" value="{{ edit_user.name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editUserEmail" value="{{ edit_user.email }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserPhone" class="form-label">Telefon</label>
                                <input type="tel" class="form-control" id="editUserPhone" value="{{ edit_user.phone or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="editUserClub" class="form-label">Członek klubu</label>
                                <select class="form-select" id="editUserClub">
                                    <option value="true" {% if edit_user.club_member %}selected{% endif %}>Tak</option>
                                    <option value="false" {% if not edit_user.club_member %}selected{% endif %}>Nie</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserActive" class="form-label">Status</label>
                                <select class="form-select" id="editUserActive">
                                    <option value="true" {% if edit_user.is_active %}selected{% endif %}>Aktywny</option>
                                    <option value="false" {% if not edit_user.is_active %}selected{% endif %}>Nieaktywny</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editUserAdmin" class="form-label">Rola</label>
                                <select class="form-select" id="editUserAdmin">
                                    <option value="false" {% if not edit_user.is_admin %}selected{% endif %}>Użytkownik</option>
                                    <option value="true" {% if edit_user.is_admin %}selected{% endif %}>Administrator</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn admin-btn">
                                <i class="fas fa-save me-2"></i>Zapisz zmiany
                            </button>
                            <a href="{{ url_for('users.index') }}" class="btn admin-btn-secondary ms-2">
                                <i class="fas fa-times me-2"></i>Anuluj
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
            
            {% if users %}
                <!-- Bulk Actions Bar -->
                <div class="bulk-actions-bar mb-3" id="bulkActionsBar" style="display: none;">
                    <div class="d-flex align-items-center gap-3">
                        <span class="text-muted">
                            <span id="selectedCount">0</span> użytkowników wybranych
                        </span>
                        <button type="button" class="btn admin-btn-danger btn-sm" id="bulkDeleteBtn">
                            <i class="fas fa-trash me-2"></i>Usuń wybrane
                        </button>
                        <button type="button" class="btn admin-btn-secondary btn-sm" onclick="clearSelection()">
                            <i class="fas fa-times me-2"></i>Anuluj
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table admin-table bulk-delete-table" id="usersTable" data-delete-endpoint="/api/bulk-delete/users">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" class="form-check-input">
                                </th>
                                <th>ID</th>
                                <th>Imię</th>
                                <th>Email</th>
                                <th>Telefon</th>
                                <th>Członek klubu</th>
                                <th>Status</th>
                                <th>Ostatnie logowanie</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr data-user-id="{{ user.id }}">
                                <td>
                                    {% if not user.is_admin %}
                                    <input type="checkbox" class="form-check-input" name="itemIds" value="{{ user.id }}">
                                    {% endif %}
                                </td>
                                <td>{{ user.id }}</td>
                                <td>
                                    <strong>{{ user.name }}</strong>
                                    {% if user.is_admin %}
                                        <br><small class="text-muted">Administrator</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="mailto:{{ user.email }}" class="text-decoration-none">
                                        {{ user.email }}
                                    </a>
                                </td>
                                <td>{{ user.phone or 'Brak' }}</td>
                                <td>
                                    {% if user.club_member %}
                                        <span class="badge admin-badge admin-badge-success">Tak</span>
                                    {% else %}
                                        <span class="badge admin-badge admin-badge-secondary">Nie</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.is_active %}
                                        <span class="badge admin-badge admin-badge-success">Aktywny</span>
                                    {% else %}
                                        <span class="badge admin-badge admin-badge-danger">Nieaktywny</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.last_login %}
                                        {{ user.last_login.strftime('%d.%m.%Y %H:%M') }}
                                    {% else %}
                                        <span class="text-muted">Nigdy</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm admin-btn-outline" 
                                                onclick="editUser({{ user.id }})" 
                                                title="Edytuj użytkownika">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% if not user.is_admin %}
                                        <button type="button" class="btn btn-sm admin-btn-danger" 
                                                onclick="deleteUser({{ user.id }})" 
                                                title="Usuń użytkownika">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Users Info -->
                {% if pagination %}
                <div class="text-center text-muted mt-3">
                    <i class="fas fa-info-circle me-1"></i>
                    Wyświetlane {{ users|length }} z {{ pagination.total }} użytkowników
                </div>
                {% endif %}
                
                <!-- Pagination -->
                {% if pagination and pagination.pages > 1 %}
                <div id="pagination" class="mt-4"></div>
                {% endif %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Brak użytkowników w systemie</p>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/utils/paginate.js') }}"></script>
<script>
    // Rozszerzona funkcjonalność bulk delete dla użytkowników
    class UsersBulkDelete extends BulkDelete {
        constructor(tableId, deleteEndpoint, options = {}) {
            super(tableId, deleteEndpoint, {
                ...options,
                confirmMessage: 'Czy na pewno chcesz usunąć wybranych użytkowników? Tej operacji nie można cofnąć.',
                successMessage: 'Użytkownicy zostali usunięci pomyślnie'
            });
        }
        
        updateDeleteButton() {
            const deleteBtn = document.getElementById(this.options.deleteButtonId);
            const bulkActionsBar = document.getElementById('bulkActionsBar');
            const selectedCountSpan = document.getElementById('selectedCount');
            
            if (!deleteBtn || !bulkActionsBar || !selectedCountSpan) return;
            
            if (this.selectedIds.size === 0) {
                bulkActionsBar.style.display = 'none';
                deleteBtn.disabled = true;
            } else {
                bulkActionsBar.style.display = 'block';
                deleteBtn.disabled = false;
                selectedCountSpan.textContent = this.selectedIds.size;
                deleteBtn.innerHTML = `<i class="fas fa-trash me-2"></i>Usuń wybrane (${this.selectedIds.size})`;
            }
        }
    }
    
    // Funkcja do czyszczenia zaznaczenia
    function clearSelection() {
        document.querySelectorAll('input[name="itemIds"]').forEach(cb => cb.checked = false);
        document.getElementById('selectAll').checked = false;
        
        // Wywołaj update dla wszystkich instancji BulkDelete
        if (window.usersBulkDelete) {
            window.usersBulkDelete.selectedIds.clear();
            window.usersBulkDelete.updateDeleteButton();
        }
    }
    
    // Inicjalizacja po załadowaniu strony
    document.addEventListener('DOMContentLoaded', function() {
        // Zastąp standardową klasę BulkDelete naszą rozszerzoną wersją
        const table = document.getElementById('usersTable');
        if (table) {
            window.usersBulkDelete = new UsersBulkDelete('usersTable', '/api/bulk-delete/users');
        }
        
        // Inicjalizacja paginacji
        {% if pagination and pagination.pages > 1 %}
        const pagination = createPaginationFromFlask(
            {
                page: {{ pagination.page }},
                pages: {{ pagination.pages }},
                total: {{ pagination.total }},
                per_page: {{ pagination.per_page }}
            },
            'pagination',
            {
                infoText: 'Strona {page} z {pages}',
                perPageOptions: [5, 10, 25, 50],
                defaultPerPage: {{ pagination.per_page }},
                showPerPage: true // Włącz selektor w funkcji pomocniczej
            }
        );
        
        // Obsługa zmiany strony
        pagination.setPageChangeCallback(function(page, perPage) {
            const url = new URL(window.location);
            url.searchParams.set('page', page);
            url.searchParams.set('per_page', perPage);
            window.location.href = url.toString();
        });
        
        // Obsługa zmiany liczby elementów na stronę
        pagination.setPerPageChangeCallback(function(page, perPage) {
            const url = new URL(window.location);
            url.searchParams.set('page', 1); // Reset to first page
            url.searchParams.set('per_page', perPage);
            window.location.href = url.toString();
        });
        {% endif %}
    });
</script>
<script>
    // Obsługa formularza edycji użytkownika
    document.addEventListener('DOMContentLoaded', function() {
        const editUserForm = document.getElementById('editUserForm');
        if (editUserForm) {
            editUserForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const userId = document.getElementById('editUserId').value;
                const userData = {
                    name: document.getElementById('editUserName').value,
                    email: document.getElementById('editUserEmail').value,
                    phone: document.getElementById('editUserPhone').value,
                    club_member: document.getElementById('editUserClub').value === 'true',
                    is_active: document.getElementById('editUserActive').value === 'true',
                    is_admin: document.getElementById('editUserAdmin').value === 'true'
                };
                
                // Wyślij żądanie aktualizacji
                fetch(`/api/user/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.toastManager.success('Użytkownik został zaktualizowany pomyślnie!');
                        // Przekieruj z powrotem do listy użytkowników
                        window.location.href = '{{ url_for("users.index") }}';
                    } else {
                        window.toastManager.error('Błąd podczas aktualizacji: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    window.toastManager.error('Wystąpił błąd podczas aktualizacji użytkownika');
                });
            });
        }
    });
    
    function editUser(userId) {
        // Znajdź użytkownika po ID i przekieruj do edycji
        const userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
        if (userRow) {
            // Email jest w 4. kolumnie (po checkbox, ID, imię)
            const email = userRow.querySelector('td:nth-child(4) a').textContent.trim();
            window.location.href = `{{ url_for('users.index') }}?edit_user=${encodeURIComponent(email)}`;
        }
    }
    
    function deleteUser(userId) {
        if (confirm('Czy na pewno chcesz usunąć tego użytkownika? Tej operacji nie można cofnąć.')) {
            fetch(`/api/user/${userId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.toastManager.success('Użytkownik został usunięty pomyślnie!');
                    // Usuń wiersz z tabeli
                    const row = document.querySelector(`tr[data-user-id="${userId}"]`);
                    if (row) {
                        row.remove();
                    }
                } else {
                    window.toastManager.error('Błąd podczas usuwania: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                window.toastManager.error('Wystąpił błąd podczas usuwania użytkownika');
            });
        }
    }
    
</script>
{% endblock %}
