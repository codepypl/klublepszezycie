<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora - Podstrony</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/admin.css') }}" rel="stylesheet">
    <!-- TinyMCE WYSIWYG Editor -->
    <script src="https://cdn.tiny.cloud/1/nzk6x47f5uoxs3thrhw5hjtjhrby1u3skrpld6z2z032z7tv/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body class="admin-body">
        <div class="container-fluid">
            <div class="row">            <!-- Sidebar -->
            {% include 'admin/sidebar.html' %}
                <!-- Main Content -->
                <main class="col-lg-10 admin-content">
                    <!-- Header -->
                    <div class="admin-header">
                        <h1>
                            <i class="fas fa-file-alt me-2"></i>
                            Zarządzanie Podstronami
                        </h1>
                        <a href="{{ url_for('admin_logout') }}" class="btn admin-btn-logout">
                            <i class="fas fa-sign-out-alt me-2"></i>
                            Wyloguj
                        </a>
                    </div>
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="admin-stats-card">
                                <i class="fas fa-file-alt"></i>
                                <h3 id="totalPages">0</h3>
                                <p>Wszystkie Podstrony</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="admin-stats-card">
                                <i class="fas fa-globe"></i>
                                <h3 id="publishedPages">0</h3>
                                <p>Opublikowane</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="admin-stats-card">
                                <i class="fas fa-eye"></i>
                                <h3 id="activePages">0</h3>
                                <p>Aktywne</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="admin-stats-card">
                                <i class="fas fa-clock"></i>
                                <h3 id="draftPages">0</h3>
                                <p>Szkice</p>
                            </div>
                        </div>
                    </div>
                    <!-- Add Page Button -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-2"></h5>
                                    <p class="text-muted mb-0"></p>
                                </div>
                                <button class="btn admin-btn" onclick="showAddPageModal()">
                                    <i class="fas fa-plus me-2"></i>
                                    Dodaj Podstronę
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pages Table -->
                    <div class="admin-card">
                        <div class="admin-card-body">
                            <div class="table-responsive">
                                <table class="table admin-table admin-table">
                                    <thead>
                                        <tr>
                                            <th>Tytuł</th>
                                            <th>Slug</th>
                                            <th>Status</th>
                                            <th>Utworzono</th>
                                            <th>Zaktualizowano</th>
                                            <th>Akcje</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pagesTableBody">
                                        <!-- Pages will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    <!-- Add/Edit Page Modal -->
    <div class="modal fade admin-modal" id="pageModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pageModalTitle">
                        <i class="fas fa-plus me-2"></i>
                        Dodaj Podstronę
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="pageForm">
                    <input type="hidden" id="page_id" name="id">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="admin-form-label">Tytuł podstrony</label>
                                    <input type="text" class="admin-form-control" name="title" id="page_title" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="admin-form-label">Slug (URL)</label>
                                    <input type="text" class="admin-form-control" name="slug" id="page_slug" required>
                                    <small class="admin-text-muted">np. o-nas, kontakt, uslugi</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="admin-form-label">Treść podstrony</label>
                            <textarea id="page_content" name="content"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="admin-form-label">Meta opis (SEO)</label>
                                    <textarea class="admin-form-control admin-form-textarea" name="meta_description" id="page_meta_description" rows="3" maxlength="300"></textarea>
                                    <small class="admin-text-muted">Maksymalnie 300 znaków</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="admin-form-label">Meta słowa kluczowe (SEO)</label>
                                    <textarea class="admin-form-control admin-form-textarea" name="meta_keywords" id="page_meta_keywords" rows="3"></textarea>
                                    <small class="admin-text-muted">Słowa kluczowe oddzielone przecinkami</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="is_active" id="page_is_active" checked>
                                    <label class="form-check-label" for="page_is_active">
                                        Aktywna
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="is_published" id="page_is_published">
                                    <label class="form-check-label" for="page_is_published">
                                        Opublikowana
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn admin-btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn admin-btn">
                            <i class="fas fa-save me-2"></i>
                            Zapisz Podstronę
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Delete Confirmation Modal -->
    <div class="modal fade admin-modal" id="deletePageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Potwierdź usunięcie
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Czy na pewno chcesz usunąć podstronę "<strong id="deletePageTitle"></strong>"?</p>
                    <p class="text-muted">Ta operacja nie może być cofnięta.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn admin-btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="button" class="btn admin-btn-danger" onclick="deletePage()">
                        <i class="fas fa-trash me-2"></i>
                        Usuń
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPageId = null;
        let deletePageId = null;
        // Initialize TinyMCE
        tinymce.init({
            selector: '#page_content',
            height: 500,
            plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount checklist mediaembed casechange export formatpainter pageembed permanentpen footnotes advtemplate advtable advcode editimage tableofcontents mergetags powerpaste tinymcespellchecker autocorrect typography inlinecss',
            toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
            tinycomments_mode: 'embedded',
            tinycomments_author: 'Author name',
            mergetags_list: [
                { value: 'First.Name', title: 'First Name' },
                { value: 'Email', title: 'Email' },
            ],
            ai_request: (request, respondWith) => respondWith.string(() => Promise.reject("See docs to implement AI Assistant")),
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif; font-size: 14px; }'
        });
        // Load pages on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPages();
        });
        // Load pages from API
        function loadPages() {
            fetch('/admin/api/pages')
                .then(response => response.json())
                .then(pages => {
                    displayPages(pages);
                    updateStats(pages);
                })
                .catch(error => {
                    console.error('Error loading pages:', error);
                    alert('Wystąpił błąd podczas ładowania podstron');
                });
        }
        // Display pages in table
        function displayPages(pages) {
            const tbody = document.getElementById('pagesTableBody');
            tbody.innerHTML = '';
            pages.forEach(page => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${page.title}</strong>
                        ${page.is_published ? '<span class="badge bg-success ms-2">Opublikowana</span>' : '<span class="badge bg-warning ms-2">Szkic</span>'}
                    </td>
                    <td><code>/${page.slug}</code></td>
                    <td>
                        ${page.is_active ? '<span class="badge bg-success">Aktywna</span>' : '<span class="badge bg-danger">Nieaktywna</span>'}
                    </td>
                    <td>${new Date(page.created_at).toLocaleDateString('pl-PL')}</td>
                    <td>${new Date(page.updated_at).toLocaleDateString('pl-PL')}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm admin-btn-outline" onclick="editPage(${page.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm admin-btn-info" onclick="viewPage('${page.slug}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm admin-btn-danger" onclick="confirmDeletePage(${page.id}, '${page.title}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        // Update statistics
        function updateStats(pages) {
            document.getElementById('totalPages').textContent = pages.length;
            document.getElementById('publishedPages').textContent = pages.filter(p => p.is_published).length;
            document.getElementById('activePages').textContent = pages.filter(p => p.is_active).length;
            document.getElementById('draftPages').textContent = pages.filter(p => !p.is_published).length;
        }
        // Show add page modal
        function showAddPageModal() {
            currentPageId = null;
            document.getElementById('pageModalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Dodaj Podstronę';
            document.getElementById('pageForm').reset();
            document.getElementById('page_id').value = '';
            // Reset TinyMCE
            tinymce.get('page_content').setContent('');
            new bootstrap.Modal(document.getElementById('pageModal')).show();
        }
        // Edit page
        function editPage(pageId) {
            fetch(`/admin/api/pages/${pageId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const page = data.page;
                        currentPageId = page.id;
                        document.getElementById('pageModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edytuj Podstronę';
                        document.getElementById('page_id').value = page.id;
                        document.getElementById('page_title').value = page.title;
                        document.getElementById('page_slug').value = page.slug;
                        document.getElementById('page_meta_description').value = page.meta_description || '';
                        document.getElementById('page_meta_keywords').value = page.meta_keywords || '';
                        document.getElementById('page_is_active').checked = page.is_active;
                        document.getElementById('page_is_published').checked = page.is_published;
                        // Set TinyMCE content
                        tinymce.get('page_content').setContent(page.content || '');
                        new bootstrap.Modal(document.getElementById('pageModal')).show();
                    } else {
                        alert('Błąd: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Wystąpił błąd podczas ładowania danych podstrony');
                });
        }
        // View page
        function viewPage(slug) {
            window.open(`/${slug}`, '_blank');
        }
        // Confirm delete page
        function confirmDeletePage(pageId, title) {
            deletePageId = pageId;
            document.getElementById('deletePageTitle').textContent = title;
            new bootstrap.Modal(document.getElementById('deletePageModal')).show();
        }
        // Delete page
        function deletePage() {
            if (!deletePageId) return;
            fetch(`/admin/api/pages?id=${deletePageId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('deletePageModal')).hide();
                    loadPages();
                    alert('Podstrona została usunięta pomyślnie!');
                } else {
                    alert('Błąd: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Wystąpił błąd podczas usuwania podstrony');
            });
        }
        // Handle form submission
        document.getElementById('pageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            // Get TinyMCE content
            formData.set('content', tinymce.get('page_content').getContent());
            // Handle checkboxes
            formData.set('is_active', document.getElementById('page_is_active').checked);
            formData.set('is_published', document.getElementById('page_is_published').checked);
            const method = currentPageId ? 'PUT' : 'POST';
            if (currentPageId) {
                formData.append('id', currentPageId);
            }
            fetch('/admin/api/pages', {
                method: method,
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('pageModal')).hide();
                    loadPages();
                    alert(currentPageId ? 'Podstrona została zaktualizowana pomyślnie!' : 'Podstrona została utworzona pomyślnie!');
                } else {
                    alert('Błąd: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Wystąpił błąd podczas zapisywania podstrony');
            });
        });
        // Auto-generate slug from title
        document.getElementById('page_title').addEventListener('input', function() {
            if (!currentPageId) { // Only auto-generate for new pages
                const title = this.value;
                const slug = title
                    .toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .trim('-');
                document.getElementById('page_slug').value = slug;
            }
        });
        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        });
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (window.innerWidth < 992 && 
                !sidebar.contains(event.target) && 
                !sidebarToggle.contains(event.target)) {
                sidebar.classList.remove('show');
            }
        });
    </script>
</body>
</html>
