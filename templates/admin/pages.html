{% extends "admin/base.html" %}

{% block title %}Podstrony{% endblock %}

{% block extra_css %}
    <!-- TinyMCE WYSIWYG Editor -->
    <script src="https://cdn.tiny.cloud/1/nzk6x47f5uoxs3thrhw5hjtjhrby1u3skrpld6z2z032z7tv/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
{% endblock %}

{% block page_title %}
    <i class="fas fa-file-alt me-2"></i>Zarządzanie Podstronami
{% endblock %}

{% block page_actions %}
    <button class="btn admin-btn" onclick="showAddPageModal()">
        <i class="fas fa-plus me-2"></i>
        Dodaj Podstronę
    </button>
{% endblock %}

{% block content %}
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-file-alt"></i>
                <h3 id="totalPages">0</h3>
                <p>Wszystkie Podstrony</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-globe"></i>
                <h3 id="publishedPages">0</h3>
                <p>Opublikowane</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-eye"></i>
                <h3 id="activePages">0</h3>
                <p>Aktywne</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-clock"></i>
                <h3 id="draftPages">0</h3>
                <p>Szkice</p>
            </div>
        </div>
    </div>
    
    <!-- Pages Table -->
    <div class="admin-card">
        <div class="admin-card-body">
            <div class="table-responsive">
                <table class="table admin-table">
                    <thead>
                        <tr>
                            <th>Kolejność</th>
                            <th>Tytuł</th>
                            <th>Slug</th>
                            <th>Status</th>
                            <th>Utworzono</th>
                            <th>Zaktualizowano</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="pagesTableBody">
                        <!-- Pages will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Page Modal -->
    <div class="modal fade" id="addPageModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Dodaj Nową Podstronę
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addPageForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="pageTitle" class="form-label">Tytuł *</label>
                                <input type="text" class="form-control" id="pageTitle" name="title" required>
                            </div>
                            <div class="col-md-6">
                                <label for="pageSlug" class="form-label">Slug *</label>
                                <input type="text" class="form-control" id="pageSlug" name="slug" required>
                            </div>

                            <div class="col-md-6">
                                <label for="pageOrder" class="form-label">Kolejność</label>
                                <input type="number" class="form-control" id="pageOrder" name="order" value="0" min="0">
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="pageActive" name="is_active" checked>
                                    <label class="form-check-label" for="pageActive">
                                        Aktywna
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="pagePublished" name="is_published">
                                    <label class="form-check-label" for="pagePublished">
                                        Opublikowana
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="pageContent" class="form-label">Treść *</label>
                                <textarea class="form-control" id="pageContent" name="content" rows="10"></textarea>
                            </div>
                            <div class="col-12">
                                <label for="pageMetaDescription" class="form-label">Meta Description</label>
                                <textarea class="form-control" id="pageMetaDescription" name="meta_description" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn admin-btn-outline" data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn admin-btn">Zapisz Podstronę</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Page Modal -->
    <div class="modal fade" id="editPageModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>Edytuj Podstronę
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editPageForm">
                    <input type="hidden" id="editPageId" name="id">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="editPageTitle" class="form-label">Tytuł *</label>
                                <input type="text" class="form-control" id="editPageTitle" name="title" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editPageSlug" class="form-label">Slug *</label>
                                <input type="text" class="form-control" id="editPageSlug" name="slug" required>
                            </div>

                            <div class="col-md-6">
                                <label for="editPageOrder" class="form-label">Kolejność</label>
                                <input type="number" class="form-control" id="editPageOrder" name="order" min="0">
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editPageActive" name="is_active">
                                    <label class="form-check-label" for="editPageActive">
                                        Aktywna
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="editPagePublished" name="is_published">
                                    <label class="form-check-label" for="editPagePublished">
                                        Opublikowana
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="editPageContent" class="form-label">Treść *</label>
                                <textarea class="form-control" id="editPageContent" name="content" rows="10"></textarea>
                            </div>
                            <div class="col-12">
                                <label for="editPageMetaDescription" class="form-label">Meta Description</label>
                                <textarea class="form-control" id="editPageMetaDescription" name="meta_description" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn admin-btn-outline" data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn admin-btn">Zapisz Zmiany</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize TinyMCE
    tinymce.init({
        selector: '#pageContent, #editPageContent',
        height: 400,
        plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount checklist mediaembed casechange export formatpainter pageembed linkchecker a11ychecker tinymcespellchecker permanentpen powerpaste advtable advcode editimage tinycomments tableofcontents footnotes mergetags autocorrect typography inlinecss',
        toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
        tinycomments_mode: 'embedded',
        tinycomments_author: 'Author name',
        mergetags_list: [
            { value: 'First.Name', title: 'First Name' },
            { value: 'Email', title: 'Email' },
        ],
        ai_request: (request, respondWith) => respondWith.string(() => Promise.reject("See docs to implement AI Assistant")),
        setup: function(editor) {
            console.log('TinyMCE initialized for:', editor.id);
        },
        init_instance_callback: function(editor) {
            console.log('TinyMCE instance ready for:', editor.id);
        }
    });

    // Helper function to check if TinyMCE is ready
    function isTinyMCEReady(editorId) {
        return tinymce.get(editorId) && tinymce.get(editorId).initialized;
    }
    
    // Load pages on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadPages();
        updateStats();
    });

    function loadPages() {
        fetch('/admin/api/pages')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPages(data.pages);
                    updateStats();
                } else {
                    console.error('Error loading pages:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function displayPages(pages) {
        const tbody = document.getElementById('pagesTableBody');
        tbody.innerHTML = '';

        pages.forEach(page => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="badge admin-badge admin-badge-primary">${page.order}</span></td>
                <td><strong>${page.title}</strong></td>
                <td><code>${page.slug}</code></td>
                <td>
                    <span class="badge admin-badge admin-badge-${getStatusBadgeClass(page.status)}">
                        ${getStatusText(page.status)}
                    </span>
                </td>
                <td>${formatDate(page.created_at)}</td>
                <td>${formatDate(page.updated_at)}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm admin-btn-outline" onclick="editPage(${page.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm admin-btn-danger" onclick="deletePage(${page.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function getStatusBadgeClass(status) {
        switch(status) {
            case 'published': return 'success';
            case 'draft': return 'warning';
            case 'archived': return 'secondary';
            default: return 'secondary';
        }
    }

    function getStatusText(status) {
        switch(status) {
            case 'published': return 'Opublikowana';
            case 'draft': return 'Szkic';
            case 'archived': return 'Zarchiwizowana';
            default: return status;
        }
    }

    function formatDate(dateString) {
        if (!dateString) return 'Brak';
        const date = new Date(dateString);
        return date.toLocaleDateString('pl-PL');
    }

    function updateStats() {
        fetch('/admin/api/pages')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const pages = data.pages;
                    document.getElementById('totalPages').textContent = pages.length;
                    document.getElementById('publishedPages').textContent = pages.filter(p => p.status === 'published').length;
                    document.getElementById('activePages').textContent = pages.filter(p => p.status === 'published').length;
                    document.getElementById('draftPages').textContent = pages.filter(p => p.status === 'draft').length;
                }
            })
            .catch(error => {
                console.error('Error updating stats:', error);
            });
    }

    function showAddPageModal() {
        document.getElementById('addPageForm').reset();
        const modal = new bootstrap.Modal(document.getElementById('addPageModal'));
        modal.show();
    }

    function editPage(pageId) {
        fetch(`/admin/api/pages/${pageId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const page = data.page;
                    document.getElementById('editPageId').value = page.id;
                    document.getElementById('editPageTitle').value = page.title;
                    document.getElementById('editPageSlug').value = page.slug;
                    document.getElementById('editPageOrder').value = page.order || 0;
                    document.getElementById('editPageActive').checked = page.is_active;
                    document.getElementById('editPagePublished').checked = page.is_published;
                    document.getElementById('editPageMetaDescription').value = page.meta_description || '';
                    
                    // Update TinyMCE content
                    tinymce.get('editPageContent').setContent(page.content || '');
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('editPageModal'));
                    modal.show();
                } else {
                    alert('Błąd podczas ładowania strony: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Wystąpił błąd podczas ładowania strony');
            });
    }

    function deletePage(pageId) {
        if (confirm('Czy na pewno chcesz usunąć tę podstronę? Tej operacji nie można cofnąć.')) {
            fetch(`/admin/api/pages?id=${pageId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Podstrona została usunięta pomyślnie!');
                    loadPages();
                } else {
                    alert('Błąd podczas usuwania: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Wystąpił błąd podczas usuwania podstrony');
            });
        }
    }

    // Form submissions
    document.getElementById('addPageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate required fields
        const title = document.getElementById('pageTitle').value.trim();
        const slug = document.getElementById('pageSlug').value.trim();
        
        if (!title) {
            alert('Proszę wprowadzić tytuł podstrony');
            document.getElementById('pageTitle').focus();
            return;
        }
        
        if (!slug) {
            alert('Proszę wprowadzić slug podstrony');
            document.getElementById('pageSlug').focus();
            return;
        }
        
        // Check if TinyMCE is ready
        if (!isTinyMCEReady('pageContent')) {
            alert('Edytor treści nie jest jeszcze gotowy. Proszę poczekać chwilę i spróbować ponownie.');
            return;
        }
        
        const content = tinymce.get('pageContent').getContent().trim();
        if (!content) {
            alert('Proszę wprowadzić treść podstrony');
            tinymce.get('pageContent').focus();
            return;
        }
        
        const formData = new FormData(this);
        formData.append('content', content);
        // Always send checkbox values as strings
        formData.set('is_active', document.getElementById('pageActive').checked ? 'true' : 'false');
        formData.set('is_published', document.getElementById('pagePublished').checked ? 'true' : 'false');
        // Add order field
        formData.set('order', document.getElementById('pageOrder').value || 0);
        
        fetch('/admin/api/pages', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Podstrona została utworzona pomyślnie!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('addPageModal'));
                modal.hide();
                loadPages();
            } else {
                alert('Błąd podczas tworzenia: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Wystąpił błąd podczas tworzenia podstrony');
        });
    });

    document.getElementById('editPageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate required fields
        const title = document.getElementById('editPageTitle').value.trim();
        const slug = document.getElementById('editPageSlug').value.trim();
        
        if (!title) {
            alert('Proszę wprowadzić tytuł podstrony');
            document.getElementById('editPageTitle').focus();
            return;
        }
        
        if (!slug) {
            alert('Proszę wprowadzić slug podstrony');
            document.getElementById('editPageSlug').focus();
            return;
        }
        
        // Check if TinyMCE is ready
        if (!isTinyMCEReady('editPageContent')) {
            alert('Edytor treści nie jest jeszcze gotowy. Proszę poczekać chwilę i spróbować ponownie.');
            return;
        }
        
        const content = tinymce.get('editPageContent').getContent().trim();
        if (!content) {
            alert('Proszę wprowadzić treść podstrony');
            tinymce.get('editPageContent').focus();
            return;
        }
        
        const formData = new FormData(this);
        formData.append('content', content);
        // Always send checkbox values as strings
        formData.set('is_active', document.getElementById('editPageActive').checked ? 'true' : 'false');
        formData.set('is_published', document.getElementById('editPagePublished').checked ? 'true' : 'false');
        // Add order field
        formData.set('order', document.getElementById('editPageOrder').value || 0);
        
        fetch('/admin/api/pages', {
            method: 'PUT',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Podstrona została zaktualizowana pomyślnie!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('editPageModal'));
                modal.hide();
                loadPages();
            } else {
                alert('Błąd podczas aktualizacji: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Wystąpił błąd podczas aktualizacji podstrony');
        });
    });
</script>
{% endblock %}
