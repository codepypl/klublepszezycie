{% extends "admin/base.html" %}

{% block title %}Kampanie Emaili - Panel Admin{% endblock %}

{% block head %}
<style>
.email-preview-container {
    isolation: isolate;
    contain: layout style;
    position: relative;
    z-index: 1;
}

.email-preview-container * {
    max-width: 100% !important;
    box-sizing: border-box !important;
}

.email-preview-container img {
    max-width: 100% !important;
    height: auto !important;
}
</style>
{% endblock %}

{% block page_title %}
    <i class="fas fa-bullhorn me-2"></i>Kampanie Emaili
{% endblock %}

{% block page_actions %}
    <div class="d-flex justify-content-end gap-2 mb-3">
        <button class="btn admin-btn" onclick="showCampaignModal()">
            <i class="fas fa-plus me-2"></i>Nowa kampania
        </button>
        <button class="btn admin-btn-danger" id="bulkDeleteBtn" style="display: none;">
            <i class="fas fa-trash me-2"></i>Usuń Zaznaczone
        </button>
    </div>
{% endblock %}

{% block content %}
    <!-- Filters -->
    <div class="admin-card mb-4">
        <div class="admin-card-header">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Filtry
                <span class="badge bg-primary ms-2" id="activeFiltersCount" style="display: none;">0 aktywny</span>
                   <button class="btn btn-sm admin-btn-outline ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse" aria-controls="filtersCollapse">
                    <i class="fas fa-chevron-down" id="filtersIcon"></i>
                </button>
            </h5>
        </div>
        <div class="collapse" id="filtersCollapse">
            <div class="admin-card-body">
                <form id="filtersForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filterName" class="form-label">Nazwa kampanii</label>
                            <input type="text" class="form-control" id="filterName" placeholder="Wpisz nazwę...">
                        </div>
                        <div class="col-md-3">
                            <label for="filterSubject" class="form-label">Temat</label>
                            <input type="text" class="form-control" id="filterSubject" placeholder="Wpisz temat...">
                        </div>
                        <div class="col-md-3">
                            <label for="filterStatus" class="form-label">Status</label>
                            <select class="form-select" id="filterStatus">
                                <option value="">Wszystkie statusy</option>
                                <option value="not_completed">Wszystkie oprócz zakończonych</option>
                                <option value="draft">Szkic</option>
                                <option value="ready">Gotowa</option>
                                <option value="sending">Wysyłanie</option>
                                <option value="sent">Wysłana</option>
                                <option value="completed">Zakończona</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end gap-2">
                            <button type="button" class="btn admin-btn" id="applyFilters">
                                <i class="fas fa-search me-2"></i>Filtruj
                            </button>
                            <button type="button" class="btn admin-btn-outline" id="clearFilters">
                                <i class="fas fa-times me-2"></i>Wyczyść
                            </button>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label for="filterDateFrom" class="form-label">Data od</label>
                            <input type="date" class="form-control" id="filterDateFrom">
                        </div>
                        <div class="col-md-3">
                            <label for="filterDateTo" class="form-label">Data do</label>
                            <input type="date" class="form-control" id="filterDateTo">
                        </div>
                        <div class="col-md-6">
                            <!-- Empty space for alignment -->
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Campaigns Table -->
    <div class="admin-card">
        <div class="admin-card-body">
                    <div class="table-responsive">
                        <table id="campaignsTable" class="table admin-table bulk-delete-table resizable-table" data-delete-endpoint="/api/bulk-delete/email-campaigns">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll">
                                    </th>
                                    <th>ID</th>
                                    <th>Nazwa</th>
                                    <th>Temat</th>
                                    <th>Status</th>
                                    <th>Odbiorcy</th>
                                    <th>Wysłane</th>
                                    <th>Utworzono</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody id="campaignsTableBody">
                                <tr>
                                    <td colspan="9" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Ładowanie...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
            <!-- Pagination -->
            <div id="pagination" class="mt-3 pagination-container" 
                 data-show-info="true" 
                 data-show-per-page="true" 
                 data-default-per-page="{{ config.PAGINATE_BY }}" 
                 data-max-visible-pages="5"></div>
        </div>
    </div>

<!-- Campaign Modal -->
<div class="modal fade" id="campaignModal" tabindex="-1" aria-labelledby="campaignModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="campaignModalLabel">Kampania Emaila</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="campaignForm">
                <div class="modal-body">
                    <input type="hidden" id="campaign_id" name="campaign_id">
                    
                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs mb-3" id="campaignTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                                <i class="fas fa-info-circle me-1"></i>Podstawowe
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tabs Content -->
                    <div class="tab-content" id="campaignTabsContent">
                        <!-- Basic Tab -->
                        <div class="tab-pane fade show active" id="basic" role="tabpanel">
                            <div class="mb-3">
                                <label for="campaign_name" class="form-label">Nazwa kampanii *</label>
                                <input type="text" class="form-control" id="campaign_name" name="campaign_name" required>
                            </div>
                    
                    <div class="mb-3">
                        <label for="campaign_subject" class="form-label">Temat emaila *</label>
                        <input type="text" class="form-control" id="campaign_subject" name="campaign_subject" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="campaign_template" class="form-label">Szablon emaila *</label>
                        <select class="form-select" id="campaign_template" name="campaign_template" required onchange="handleTemplateChange()">
                            <option value="">Wybierz szablon</option>
                        </select>
                        <div class="form-text">Wybierz szablon, który będzie używany do generowania emaili</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="campaign_groups" class="form-label">Grupy odbiorców *</label>
                        <select class="form-select" id="campaign_groups" name="campaign_groups" multiple required>
                            <option value="">Wybierz grupy</option>
                        </select>
                        <div class="form-text">Przytrzymaj Ctrl (Cmd na Mac) aby wybrać wiele grup</div>
                    </div>
                    
                    <div id="templateVariables" class="mb-3" style="display: none;">
                        <label class="form-label">Treść do wstawienia w szablon</label>
                        <div id="variablesContainer">
                            <!-- Variables will be loaded here dynamically -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Podgląd emaila</label>
                        <div id="emailPreview" class="border p-3 bg-light" style="min-height: 200px; isolation: isolate; contain: layout style;">
                            <p class="text-muted">Wybierz szablon aby zobaczyć podgląd</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Planowanie wysyłki</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="send_type" id="send_immediate" value="immediate" checked onchange="toggleScheduling()">
                                    <label class="form-check-label" for="send_immediate">
                                        Wysłać natychmiast
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="send_type" id="send_scheduled" value="scheduled" onchange="toggleScheduling()">
                                    <label class="form-check-label" for="send_scheduled">
                                        Zaplanować wysyłkę
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="schedulingOptions" style="display: none;">
                                    <label for="campaign_scheduled_at" class="form-label">Data i czas wysyłki</label>
                                    <input type="datetime-local" class="form-control" id="campaign_scheduled_at" name="campaign_scheduled_at">
                                    <div class="form-text">Wybierz datę i czas wysyłki kampanii</div>
                                </div>
                            </div>
                        </div>
                        </div>
                        <!-- END Basic Tab -->
                        
                    </div>
                    <!-- END Tab Content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn admin-btn-outline" data-bs-dismiss="modal">Anuluj</button>
                    <button type="button" class="btn admin-btn" onclick="saveCampaign()">Zapisz kampanię</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/utils/table-resizer.js') }}?v={{ range(1000000, 9999999) | random }}"></script>
<script src="{{ url_for('static', filename='js/admin/email_campaigns.js') }}?v={{ range(1000000, 9999999) | random }}"></script>

{% endblock %}
