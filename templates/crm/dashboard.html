{% extends "admin/base.html" %}

{% block title %}Dashboard Ankietera - {{ super() }}{% endblock %}

{% block page_title %}
    <i class="fas fa-chart-bar me-2"></i>Dashboard Ankietera
{% endblock %}

{% block page_actions %}
    <!-- Przycisk synchronizacji z Twilio -->
    <button class="btn btn-info me-2" onclick="syncWithTwilio()" title="Synchronizuj statystyki z Twilio">
        <i class="fas fa-sync-alt me-1"></i>Sync z Twilio
    </button>
{% endblock %}

{% block content %}
    <!-- Stats Cards - Dzienne (zerowanie ka≈ºdego dnia) -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-star"></i>
                <h3 id="leadsToday">0</h3>
                <p>Leady (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-phone"></i>
                <h3 id="answeredToday">0</h3>
                <p>Wykonane (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-calendar-plus"></i>
                <h3 id="callbacksToday">0</h3>
                <p>Prze≈Ço≈ºenia (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-clock"></i>
                <h3 id="longestCallToday">0:00</h3>
                <p>Najd≈Çu≈ºsza rozmowa (dzisiaj)</p>
            </div>
        </div>
    </div>

    <!-- Stats Cards - ≈ÅƒÖczne -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-phone-alt"></i>
                <h3 id="totalAnswered">0</h3>
                <p>Wykonane ≈ÇƒÖcznie</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-redo"></i>
                <h3 id="totalCallbacks">0</h3>
                <p>≈ÅƒÖczna liczba recalli</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-user-clock"></i>
                <h3 id="totalLoginTimeToday">00:00:00</h3>
                <p>≈ÅƒÖczny czas zalogowania (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-briefcase"></i>
                <h3 id="totalWorkTimeToday">00:00:00</h3>
                <p>≈ÅƒÖczny czas pracy (dzisiaj)</p>
            </div>
        </div>
    </div>

    <!-- Stats Cards - Czasowe -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-stopwatch"></i>
                <h3 id="avgCallTime">0:00</h3>
                <p>≈örednia rozmowa (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-coffee"></i>
                <h3 id="totalBreakTimeToday">00:00:00</h3>
                <p>≈ÅƒÖczny czas przerw (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-chart-line"></i>
                <h3 id="successRate">0%</h3>
                <p>Wska≈∫nik sukcesu</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-list"></i>
                <h3 id="queueCount">0</h3>
                <p>W kolejce</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5><i class="fas fa-bolt me-2"></i>Funkcje Ankietera</h5>
                </div>
                <div class="admin-card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <a href="{{ url_for('ankieter.work') }}" class="btn admin-btn w-100">
                                <i class="fas fa-headset me-2"></i>Rozpocznij pracƒô
                            </a>
                        </div>
                        <div class="col-md-6 mb-3">
                            <a href="{{ url_for('users.profile') }}" class="btn admin-btn-secondary w-100">
                                <i class="fas fa-user me-2"></i>M√≥j profil
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let dashboardRefreshInterval;

// Load statistics from API
async function loadDashboardStats() {
    try {
        console.log('üîÑ Loading dashboard stats...');
        const response = await fetch('/api/crm/agent/queue-status');
        const data = await response.json();
        
        console.log('üìä Dashboard API response:', data);
        
        if (data.success) {
            // Today's statistics
            const leadsToday = data.today_stats.leads || 0;
            const answeredToday = data.today_stats.completed_calls || 0;
            const callbacksToday = data.today_stats.callbacks || 0;
            const longestCallToday = data.today_stats.longest_call_seconds || 0;
            
            console.log('üìà Today stats:', {
                leads: leadsToday,
                answered: answeredToday,
                callbacks: callbacksToday,
                longestCall: longestCallToday
            });
            
            document.getElementById('leadsToday').textContent = leadsToday;
            document.getElementById('answeredToday').textContent = answeredToday;
            document.getElementById('callbacksToday').textContent = callbacksToday;
            document.getElementById('longestCallToday').textContent = formatDuration(longestCallToday);
            
            // Total statistics
            const totalAnswered = data.total_stats.completed_calls || 0;
            const totalCallbacks = data.total_stats.callbacks || 0;
            
            console.log('üìä Total stats:', {
                answered: totalAnswered,
                callbacks: totalCallbacks
            });
            
            document.getElementById('totalAnswered').textContent = totalAnswered;
            document.getElementById('totalCallbacks').textContent = totalCallbacks;
            
            // Time statistics - new ones
            const totalLoginTime = data.today_stats.total_login_time_seconds || 0;
            const totalWorkTime = data.today_stats.total_work_time_seconds || 0;
            const totalBreakTime = data.today_stats.total_break_time_seconds || 0;
            const avgCallTime = data.today_stats.avg_call_time_seconds || 0;
            
            console.log('‚è∞ Time stats:', {
                loginTime: totalLoginTime,
                workTime: totalWorkTime,
                breakTime: totalBreakTime,
                avgCallTime: avgCallTime
            });
            
            document.getElementById('totalLoginTimeToday').textContent = formatTimeDuration(totalLoginTime);
            document.getElementById('totalWorkTimeToday').textContent = formatTimeDuration(totalWorkTime);
            document.getElementById('totalBreakTimeToday').textContent = formatTimeDuration(totalBreakTime);
            document.getElementById('avgCallTime').textContent = formatDuration(avgCallTime);
            
            // Calculate success rate
            const totalCalls = (data.today_stats.leads || 0) + (data.today_stats.rejections || 0) + 
                              (data.today_stats.callbacks || 0) + (data.today_stats.no_answer || 0) + 
                              (data.today_stats.busy || 0) + (data.today_stats.wrong_number || 0);
            const successRate = totalCalls > 0 ? Math.round((data.today_stats.leads || 0) / totalCalls * 100) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
            
            // Queue count
            const queueCount = (data.queue.callbacks || 0) + (data.queue.potentials || 0) + (data.queue.new_contacts || 0);
            document.getElementById('queueCount').textContent = queueCount;
            
            console.log('‚úÖ Dashboard stats loaded successfully');
        } else {
            console.error('‚ùå Error loading dashboard stats:', data.error);
        }
    } catch (error) {
        console.error('‚ùå Error loading dashboard stats:', error);
    }
}

function formatDuration(seconds) {
    if (!seconds || seconds < 0) return '0:00';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

function formatTimeDuration(seconds) {
    if (!seconds || seconds < 0) return '00:00:00';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function refreshDashboard() {
    const refreshBtn = document.getElementById('refreshBtn');
    const icon = refreshBtn.querySelector('i');
    
    // Show loading state
    icon.className = 'fas fa-spinner fa-spin me-2';
    refreshBtn.disabled = true;
    
    // Load stats
    loadDashboardStats().finally(() => {
        // Reset button state
        icon.className = 'fas fa-sync me-2';
        refreshBtn.disabled = false;
    });
}

// Load stats on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    
    // Auto-refresh every 1 second
    dashboardRefreshInterval = setInterval(loadDashboardStats, 1000);
    
    console.log('üîÑ Dashboard Ankietera zainicjalizowany');
});

// Clean up interval on page unload
window.addEventListener('beforeunload', function() {
    if (dashboardRefreshInterval) {
        clearInterval(dashboardRefreshInterval);
    }
});

// Synchronizacja statystyk z Twilio
async function syncWithTwilio() {
    try {
        const response = await fetch('/api/crm/agent/sync-twilio-stats', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                date: new Date().toISOString().split('T')[0] // Today's date
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show comparison modal
            showTwilioComparison(data);
        } else {
            showError('B≈ÇƒÖd synchronizacji z Twilio: ' + data.error);
        }
    } catch (error) {
        console.error('Error syncing with Twilio:', error);
        showError('B≈ÇƒÖd podczas synchronizacji z Twilio');
    }
}

// Show Twilio comparison modal
function showTwilioComparison(data) {
    const comparison = data.comparison;
    const modalHtml = `
        <div class="modal fade" id="twilioComparisonModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-sync-alt me-2"></i>Por√≥wnanie statystyk z Twilio
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-database me-2"></i>Nasza baza danych</h6>
                                <ul class="list-unstyled">
                                    <li><strong>≈ÅƒÖczne po≈ÇƒÖczenia:</strong> ${comparison.database.total_calls}</li>
                                    <li><strong>Wykonane po≈ÇƒÖczenia:</strong> ${comparison.database.completed_calls}</li>
                                    <li><strong>≈ÅƒÖczny czas:</strong> ${formatTimeDuration(comparison.database.total_duration_seconds)}</li>
                                    <li><strong>Najd≈Çu≈ºsza rozmowa:</strong> ${formatTimeDuration(comparison.database.longest_call_seconds)}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fab fa-twilio me-2"></i>Twilio</h6>
                                <ul class="list-unstyled">
                                    <li><strong>≈ÅƒÖczne po≈ÇƒÖczenia:</strong> ${comparison.twilio.total_calls}</li>
                                    <li><strong>Wykonane po≈ÇƒÖczenia:</strong> ${comparison.twilio.completed_calls}</li>
                                    <li><strong>≈ÅƒÖczny czas:</strong> ${formatTimeDuration(comparison.twilio.total_duration_seconds)}</li>
                                    <li><strong>Najd≈Çu≈ºsza rozmowa:</strong> ${formatTimeDuration(comparison.twilio.longest_call_seconds)}</li>
                                </ul>
                            </div>
                        </div>
                        
                        ${comparison.missing_calls > 0 ? `
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Znaleziono ${comparison.missing_calls} po≈ÇƒÖcze≈Ñ w Twilio, kt√≥rych nie ma w naszej bazie danych.</strong>
                            <br>
                            <small>Call SIDs: ${comparison.missing_sids.join(', ')}</small>
                        </div>
                        ` : `
                        <div class="alert alert-success mt-3">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Statystyki sƒÖ zsynchronizowane!</strong>
                        </div>
                        `}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                        ${comparison.missing_calls > 0 ? `
                        <button type="button" class="btn btn-warning" onclick="importMissingCalls('${data.date}')">
                            <i class="fas fa-download me-1"></i>Importuj brakujƒÖce po≈ÇƒÖczenia
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('twilioComparisonModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('twilioComparisonModal'));
    modal.show();
}

// Import missing calls from Twilio
async function importMissingCalls(date) {
    try {
        showInfo('Importowanie brakujƒÖcych po≈ÇƒÖcze≈Ñ z Twilio...');
        
        // This would be a separate endpoint to import missing calls
        // For now, just show a message
        showInfo('Funkcja importu brakujƒÖcych po≈ÇƒÖcze≈Ñ bƒôdzie dostƒôpna wkr√≥tce.');
        
    } catch (error) {
        console.error('Error importing missing calls:', error);
        showError('B≈ÇƒÖd podczas importu brakujƒÖcych po≈ÇƒÖcze≈Ñ');
    }
}
</script>
{% endblock %}