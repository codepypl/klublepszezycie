{% extends "admin/base.html" %}

{% block title %}Dashboard Ankietera - {{ super() }}{% endblock %}

{% block page_title %}
    <i class="fas fa-chart-bar me-2"></i>Dashboard Ankietera
{% endblock %}

{% block page_actions %}
    <!-- Przycisk od≈õwie≈º usuniƒôty - statystyki od≈õwie≈ºajƒÖ siƒô automatycznie co 1 sekundƒô -->
{% endblock %}

{% block content %}
    <!-- Stats Cards - Dzienne (zerowanie ka≈ºdego dnia) -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-star"></i>
                <h3 id="leadsToday">0</h3>
                <p>Leady (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-phone"></i>
                <h3 id="answeredToday">0</h3>
                <p>Wykonane (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-calendar-plus"></i>
                <h3 id="callbacksToday">0</h3>
                <p>Prze≈Ço≈ºenia (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-clock"></i>
                <h3 id="longestCallToday">0:00</h3>
                <p>Najd≈Çu≈ºsza rozmowa (dzisiaj)</p>
            </div>
        </div>
    </div>

    <!-- Stats Cards - ≈ÅƒÖczne -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-phone-alt"></i>
                <h3 id="totalAnswered">0</h3>
                <p>Wykonane ≈ÇƒÖcznie</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-redo"></i>
                <h3 id="totalCallbacks">0</h3>
                <p>≈ÅƒÖczna liczba recalli</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-user-clock"></i>
                <h3 id="totalLoginTimeToday">00:00:00</h3>
                <p>≈ÅƒÖczny czas zalogowania (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-briefcase"></i>
                <h3 id="totalWorkTimeToday">00:00:00</h3>
                <p>≈ÅƒÖczny czas pracy (dzisiaj)</p>
            </div>
        </div>
    </div>

    <!-- Stats Cards - Czasowe -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-stopwatch"></i>
                <h3 id="avgCallTime">0:00</h3>
                <p>≈örednia rozmowa (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-coffee"></i>
                <h3 id="totalBreakTimeToday">00:00:00</h3>
                <p>≈ÅƒÖczny czas przerw (dzisiaj)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-chart-line"></i>
                <h3 id="successRate">0%</h3>
                <p>Wska≈∫nik sukcesu</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats-card">
                <i class="fas fa-list"></i>
                <h3 id="queueCount">0</h3>
                <p>W kolejce</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5><i class="fas fa-bolt me-2"></i>Funkcje Ankietera</h5>
                </div>
                <div class="admin-card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <a href="{{ url_for('ankieter.work') }}" class="btn admin-btn w-100">
                                <i class="fas fa-headset me-2"></i>Rozpocznij pracƒô
                            </a>
                        </div>
                        <div class="col-md-6 mb-3">
                            <a href="{{ url_for('users.profile') }}" class="btn admin-btn-secondary w-100">
                                <i class="fas fa-user me-2"></i>M√≥j profil
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let dashboardRefreshInterval;

// Load statistics from API
async function loadDashboardStats() {
    try {
        const response = await fetch('/api/crm/agent/queue-status');
        const data = await response.json();
        
        if (data.success) {
            // Today's statistics
            document.getElementById('leadsToday').textContent = data.today_stats.leads || 0;
            document.getElementById('answeredToday').textContent = (data.today_stats.leads || 0) + (data.today_stats.rejections || 0) + (data.today_stats.callbacks || 0) + (data.today_stats.no_answer || 0) + (data.today_stats.busy || 0) + (data.today_stats.wrong_number || 0);
            document.getElementById('callbacksToday').textContent = data.today_stats.callbacks || 0;
            document.getElementById('longestCallToday').textContent = formatDuration(data.today_stats.longest_call_seconds || 0);
            
            // Total statistics
            document.getElementById('totalAnswered').textContent = (data.total_stats.leads || 0) + (data.total_stats.rejections || 0) + (data.total_stats.callbacks || 0) + (data.total_stats.no_answer || 0) + (data.total_stats.busy || 0) + (data.total_stats.wrong_number || 0);
            document.getElementById('totalCallbacks').textContent = data.total_stats.callbacks || 0;
            
            // Time statistics - new ones
            document.getElementById('totalLoginTimeToday').textContent = formatTimeDuration(data.today_stats.total_login_time_seconds || 0);
            document.getElementById('totalWorkTimeToday').textContent = formatTimeDuration(data.today_stats.total_work_time_seconds || 0);
            document.getElementById('totalBreakTimeToday').textContent = formatTimeDuration(data.today_stats.total_break_time_seconds || 0);
            
            // Existing time statistics
            document.getElementById('avgCallTime').textContent = formatDuration(data.today_stats.avg_call_time_seconds || 0);
            
            // Calculate success rate
            const totalCalls = (data.today_stats.leads || 0) + (data.today_stats.rejections || 0) + 
                              (data.today_stats.callbacks || 0) + (data.today_stats.no_answer || 0) + 
                              (data.today_stats.busy || 0) + (data.today_stats.wrong_number || 0);
            const successRate = totalCalls > 0 ? Math.round((data.today_stats.leads || 0) / totalCalls * 100) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
            
            // Queue count
            const queueCount = (data.queue.callbacks || 0) + (data.queue.potentials || 0) + (data.queue.new_contacts || 0);
            document.getElementById('queueCount').textContent = queueCount;
        } else {
            console.error('Error loading dashboard stats:', data.error);
        }
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

function formatDuration(seconds) {
    if (!seconds || seconds < 0) return '0:00';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

function formatTimeDuration(seconds) {
    if (!seconds || seconds < 0) return '00:00:00';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function refreshDashboard() {
    const refreshBtn = document.getElementById('refreshBtn');
    const icon = refreshBtn.querySelector('i');
    
    // Show loading state
    icon.className = 'fas fa-spinner fa-spin me-2';
    refreshBtn.disabled = true;
    
    // Load stats
    loadDashboardStats().finally(() => {
        // Reset button state
        icon.className = 'fas fa-sync me-2';
        refreshBtn.disabled = false;
    });
}

// Load stats on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    
    // Auto-refresh every 1 second
    dashboardRefreshInterval = setInterval(loadDashboardStats, 1000);
    
    console.log('üîÑ Dashboard Ankietera zainicjalizowany');
});

// Clean up interval on page unload
window.addEventListener('beforeunload', function() {
    if (dashboardRefreshInterval) {
        clearInterval(dashboardRefreshInterval);
    }
});
</script>
{% endblock %}